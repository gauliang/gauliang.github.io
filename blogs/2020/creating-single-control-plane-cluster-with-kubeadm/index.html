<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta content="viewport-fit=cover, width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/><title>使用 kubeadm 安装单控制平面 Kubernetes 集群 - Gauliang</title><meta name="next-head-count" content="3"/><link href="https://unpkg.com/prismjs@0.0.1/themes/prism-okaidia.css" rel="stylesheet"/><link rel="icon" href="/favicon.svg"/><link rel="apple-touch-icon" href="/favicon.png"/><link rel="apple-touch-startup-image" href="/favicon.png"/><link rel="manifest" href="/manifest.json"/><meta name="apple-mobile-web-app-title" content="Blog"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><meta name="theme-color" content="#FFF"/><link rel="preload" href="/_next/static/css/94c0c4896385cbfc.css" as="style"/><link rel="stylesheet" href="/_next/static/css/94c0c4896385cbfc.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-d7b038a63b619762.js" defer=""></script><script src="/_next/static/chunks/framework-a87821de553db91d.js" defer=""></script><script src="/_next/static/chunks/main-03586e2758997a42.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f1e48f2808f3843c.js" defer=""></script><script src="/_next/static/chunks/0c428ae2-cbec42c88474d6d7.js" defer=""></script><script src="/_next/static/chunks/167-1f992d16f0af3a0d.js" defer=""></script><script src="/_next/static/chunks/424-df8d47b174038bde.js" defer=""></script><script src="/_next/static/chunks/pages/blogs/%5B...id%5D-6a2f6ffd029f66d2.js" defer=""></script><script src="/_next/static/QAI6xvOdSiTAPcw5Wz8zx/_buildManifest.js" defer=""></script><script src="/_next/static/QAI6xvOdSiTAPcw5Wz8zx/_ssgManifest.js" defer=""></script><script src="/_next/static/QAI6xvOdSiTAPcw5Wz8zx/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><nav class="md:sticky md:top-0 backdrop-blur md:bg-white/80 border-gray-200 md:border-b py-1 md:py-5 md:px-5 dark:bg-gray-800 dark:border-gray-700 z-10"><div class="md:container md:mx-auto flex flex-wrap flex-col md:flex-row justify-between"><div class="hidden md:flex px-5 md:px-0 flex-row justify-between text-[#0069ff] dark:text-white"><div class="flex flex-row cursor-pointer"><div class="w-6 h-6 my-2 md:w-8 md:h-8 md:my-1"><svg viewBox="0 0 512 512" fill="currentColor"><path d="M238.74,366.17c-24.56,0.42-12.59,0.42-36.76,0 C92.86,358.74,92.54,257.24,92.54,257.24s-3.78-104.91,109.44-110.42c105.79,0.4,195.22,0.23,242.54,0.08 c40.86-0.53,36.61-7.61,26.7-24.61C447.75,81.99,384.8,3.28,250.71,0C-60.02,17.45-88.35,433.93,194.97,504.76 c42.5,12.75,91.65,4.77,91.65,4.77s-0.23-52.54,0-94.13C286.82,378.65,274.71,365.55,238.74,366.17z M482.55,207.28 c-12,0.02-229.21,1.03-280.57,0.86c-48.75-0.16-48.73,49.23-48.73,49.23s0.19,47.49,48.73,47.5c-0.03,0,109.56-0.35,121.41,0 c11.91,0.35,24.03,12.59,23.94,25.04c-0.19,27.35,0.46,163.59,0.64,163.53c24.08-8.5,157.24-66.58,161.49-236.57 C510.08,231.99,506.75,207.3,482.55,207.28z"></path></svg></div><span class="text-xl h-8 ml-2 my-1.5 font-semibold">Gauliang</span></div><div class="md:hidden"><div class="relative"><button class=" flex h-10 flex-row items-center py-2 focus:outline-none text-blue-500 dark:text-blue-500 md:dark:text-white md:text-inherit" id="headlessui-popover-button-:R9d6:" type="button" aria-expanded="false"><span class="dark:hidden"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></svg> <!-- --></span><span class="hidden dark:inline"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.858 1.311A7.269 7.269 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.316 7.316 0 0 0 5.205-2.162c-.337.042-.68.063-1.029.063-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></svg></span></button></div></div></div><div class="hidden md:flex items-start md:items-center flex-col md:flex-row mt-2 md:mt-0 mb-5 md:mb-0"><ul class="flex flex-row justify-between ml-2 md:ml-0 space-x-0 md:space-x-6 "><li><a class="block py-2 mx-3 font-semibold md:border-none " href="/">首页</a></li><li><a class="block py-2 mx-3 font-semibold md:border-none text-blue-500 border-b-2 border-blue-500" href="/blogs/">博客</a></li><li><a class="block py-2 mx-3 font-semibold md:border-none " href="/tags/">标签</a></li><li><a class="block py-2 mx-3 font-semibold md:border-none " href="/series/">系列</a></li><li><a class="block py-2 mx-3 font-semibold md:border-none " href="/about/">关于</a></li></ul><ul class="flex-row space-x-6 border-l dark:border-slate-600 ml-6 pl-6 hidden md:flex"><li><div class="relative"><button class=" flex h-10 flex-row items-center py-2 focus:outline-none text-blue-500 dark:text-blue-500 md:dark:text-white md:text-inherit" id="headlessui-popover-button-:Rqd6:" type="button" aria-expanded="false"><span class="dark:hidden"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></svg> <!-- --></span><span class="hidden dark:inline"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.858 1.311A7.269 7.269 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.316 7.316 0 0 0 5.205-2.162c-.337.042-.68.063-1.029.063-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></svg></span></button></div></li><li><a href="https://github.com/gauliang" target="_blank" rel="noreferrer" class="block py-1 "><svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.463 2 11.97c0 4.404 2.865 8.14 6.839 9.458.5.092.682-.216.682-.48 0-.236-.008-.864-.013-1.695-2.782.602-3.369-1.337-3.369-1.337-.454-1.151-1.11-1.458-1.11-1.458-.908-.618.069-.606.069-.606 1.003.07 1.531 1.027 1.531 1.027.892 1.524 2.341 1.084 2.91.828.092-.643.35-1.083.636-1.332-2.22-.251-4.555-1.107-4.555-4.927 0-1.088.39-1.979 1.029-2.675-.103-.252-.446-1.266.098-2.638 0 0 .84-.268 2.75 1.022A9.606 9.606 0 0112 6.82c.85.004 1.705.114 2.504.336 1.909-1.29 2.747-1.022 2.747-1.022.546 1.372.202 2.386.1 2.638.64.696 1.028 1.587 1.028 2.675 0 3.83-2.339 4.673-4.566 4.92.359.307.678.915.678 1.846 0 1.332-.012 2.407-.012 2.734 0 .267.18.577.688.48C19.137 20.107 22 16.373 22 11.969 22 6.463 17.522 2 12 2z"></path></svg></a></li></ul></div><div class="flex pl-2 pr-5 justify-between items-center md:hidden"><a class="flex flex-row items-center justify-start space-x-2 text-blue-500 dark:text-blue-500 font-bold" href="/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"></path></svg><span>首页</span></a><div class="relative"><button class=" flex h-10 flex-row items-center py-2 focus:outline-none text-blue-500 dark:text-blue-500 md:dark:text-white md:text-inherit" id="headlessui-popover-button-:Rbd6:" type="button" aria-expanded="false"><span class="dark:hidden"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></svg> <!-- --></span><span class="hidden dark:inline"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.858 1.311A7.269 7.269 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.316 7.316 0 0 0 5.205-2.162c-.337.042-.68.063-1.029.063-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></svg></span></button></div></div></div></nav><main class="mx-auto container"><div class="mx-5 xl:mx-10 flex flex-row md:space-x-8"><div class="hidden md:block md:basis-1/6 shrink-0 py-20"><div class="sticky top-28"><div class="uppercase text-black dark:text-white font-bold">Contents</div><ul class="TableOfContents text-gray-400 mt-5 text-sm"><li class="mb-3"><a href="#hash-一、拓扑结构" class="nav-link ">一、拓扑结构</a></li><li class="mb-3"><a href="#hash-二、准备工作" class="nav-link ">二、准备工作</a></li><li class="mb-3"><a href="#hash-三、部署控制平面节点" class="nav-link ">三、部署控制平面节点</a></li><li class="mb-3"><a href="#hash-四、加入工作节点" class="nav-link ">四、加入工作节点</a></li><li class="mb-3"><a href="#hash-五、安装-Dashboard" class="nav-link ">五、安装 Dashboard</a></li><li class="mb-3"><a href="#hash-六、Inress-nginx" class="nav-link ">六、Inress-nginx</a></li><li class="mb-3"><a href="#hash-七、访问-Dashboard" class="nav-link ">七、访问 Dashboard</a></li><li class="mb-3"><a href="#hash-八、完成" class="nav-link ">八、完成</a></li></ul></div></div><div class="basis-3/3 w-full md:w-1 md:basis-5/6 xl:basis-4/6"><div class="md:mb-12 border-gray-200 py-8 md:py-20"><div class="flex space-x-2 items-center text-sm font-light text-gray-600 dark:text-gray-400"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"></path></svg><div>阅读全文约需 <!-- -->32<!-- --> 分钟<!-- --></div><div class="grow"></div></div><h1 class="text-2xl md:text-5xl md:leading-tight my-4 md:my-8 subpixel-antialiased font-semibold">使用 kubeadm 安装单控制平面 Kubernetes 集群</h1><div class="text-sm text-gray-600 dark:text-gray-400 font-light flex items-center space-x-2"><time>2020-01-19 20:30:54</time><span>By</span><span>Gl</span></div></div><article class="post-content"><div class="image-widget"><img src="/attachments/posts/2020/creating-single-control-plane-cluster-with-kubeadm.files/cover.png" alt="部署单控制平面 k8s 集群，并安装 Dashboard 和 ingress-nginx 使外部浏览器可以访问集群。"><div class="figcaption">部署单控制平面 k8s 集群，并安装 Dashboard 和 ingress-nginx 使外部浏览器可以访问集群。</div></div>
<h2 id="hash-一、拓扑结构">一、拓扑结构</h2>
<p>本文主要介绍如何使用 kubeadm 安装部署单控制平面 Kubernetes v1.17.0 集群，所谓单控制平面，顾名思义就是由一个 Control-plane Node 和多个 Work Node 组成的 Kubernetes 集群。高可用集群与此不同，其由多个 Control-plane Node 和多个 Work Node 组成，高可用集群部署中，根据 etcd 数据库部署位置的不同，又分为栈内 etcd 数据库部署和外部独立 etcd 数据库集群部署两种模式。
下面展示了不同部署模式的拓扑结构：</p>
<div class="image-widget"><img src="/attachments/posts/2020/creating-single-control-plane-cluster-with-kubeadm.files/kubeadm-scp-topology.svg" alt="单控制平面拓扑结构"><div class="figcaption">单控制平面拓扑结构</div></div>
<div class="image-widget"><img src="/attachments/posts/2020/creating-single-control-plane-cluster-with-kubeadm.files/kubeadm-ha-topology-stacked-etcd.svg" alt="高可用拓扑结构（栈内 etcd 数据库）"><div class="figcaption">高可用拓扑结构（栈内 etcd 数据库）</div></div>
<div class="image-widget"><img src="/attachments/posts/2020/creating-single-control-plane-cluster-with-kubeadm.files/kubeadm-ha-topology-external-etcd.svg" alt="高可用拓扑结构（外部独立 etcd 数据库集群）"><div class="figcaption">高可用拓扑结构（外部独立 etcd 数据库集群）</div></div>
<p>高可用部署与单控制平面部署不同，不过，除负载均衡及多 kube-apiserver 部分外，其他流程大同小异。有关高可用安装的更多信息请参考 <a target="_blank" target="_blank" class="ext-link" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/">Creating Highly Available clusters with kubeadm</a>。</p>
<h2 id="hash-二、准备工作">二、准备工作</h2>
<p>硬件要求，建议 4 核以上 CPU，8GB 以上内存，Ubuntu 16.04 以上或 CentOS 7 以上版本的操作系统，确保所有服务器间网络通信正常，1 台服务器作为控制平面节点，其余若干台服务器作为工作节点，我这里准备了4个工作节点。基本信息如下：</p>
<div class="table-responsive"><table>
<thead>
<tr>
<th>名称</th>
<th>CPU</th>
<th>内存</th>
<th>IP</th>
<th>OS</th>
<th>安装</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>CPN-1</td>
<td>4U</td>
<td>8GB</td>
<td>10.163.10.6</td>
<td>ubuntu18.04</td>
<td>docker , kubeadm, kubelet , kubectl</td>
<td>Control Plane Node</td>
</tr>
<tr>
<td>WN-1</td>
<td>4U</td>
<td>8GB</td>
<td>10.163.10.7</td>
<td>ubuntu18.04</td>
<td>docker , kubeadm, kubelet</td>
<td>Worker Node</td>
</tr>
<tr>
<td>WN-2</td>
<td>4U</td>
<td>8GB</td>
<td>10.163.10.8</td>
<td>ubuntu18.04</td>
<td>docker , kubeadm, kubelet</td>
<td>Worker Node</td>
</tr>
<tr>
<td>WN-2</td>
<td>4U</td>
<td>8GB</td>
<td>10.163.10.9</td>
<td>ubuntu18.04</td>
<td>docker , kubeadm, kubelet</td>
<td>Worker Node</td>
</tr>
<tr>
<td>WN-2</td>
<td>4U</td>
<td>8GB</td>
<td>10.163.10.10</td>
<td>ubuntu18.04</td>
<td>docker , kubeadm, kubelet</td>
<td>Worker Node</td>
</tr>
</tbody>
</table></div>
<h3 id="hash-安装-docker">安装 docker</h3>
<p>K8S 支持多种容器运行时环境，我们选择 docker，首先为所有节点服务器安装 docker，目前 kubernetes 最新版(v1.17.0) 可以完全兼容支持的 docker 最高版本为 v19.03，我们选择 Docker 的最新稳定版本 v19.03 作为容器运行时环境。安装细节可参考 <a target="_blank" target="_blank" class="ext-link" href="https://docs.docker.com/install/linux/docker-ce/ubuntu/">Get Docker Engine - Community for Ubuntu</a>。</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 删除旧版本docker</span>
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> remove <span class="token function">docker</span> docker-engine docker.io containerd runc

<span class="token comment"># 更新 apt </span>
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update

<span class="token comment"># 安装工具包</span>
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token punctuation">\</span>
    apt-transport-https <span class="token punctuation">\</span>
    ca-certificates <span class="token punctuation">\</span>
    <span class="token function">curl</span> <span class="token punctuation">\</span>
    gnupg-agent <span class="token punctuation">\</span>
    software-properties-common

<span class="token comment"># 添加Docker官方 GPG key</span>
$ <span class="token function">curl</span> -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -

<span class="token comment"># 添加 stable apt 源</span>
$ <span class="token function">sudo</span> add-apt-repository <span class="token punctuation">\</span>
   <span class="token string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> \
   stable"</span>

<span class="token comment"># 安装 Docker CE</span>
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token punctuation">\</span>
  containerd.io<span class="token operator">=</span><span class="token number">1.2</span>.10-3 <span class="token punctuation">\</span>
  docker-ce<span class="token operator">=</span><span class="token number">5</span>:19.03.4~3-0~ubuntu-<span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> <span class="token punctuation">\</span>
  docker-ce-cli<span class="token operator">=</span><span class="token number">5</span>:19.03.4~3-0~ubuntu-<span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span>
</code></pre></div>
<p>如果你的网络环境从官方仓库安装速度较慢，可以使用阿里云镜像仓库安装。步骤如下：</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># step 1: 安装必要的一些系统工具</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> -y <span class="token function">install</span> apt-transport-https ca-certificates <span class="token function">curl</span> software-properties-common

<span class="token comment"># step 2: 安装GPG证书</span>
<span class="token function">curl</span> -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -

<span class="token comment"># Step 3: 写入软件源信息</span>
<span class="token function">sudo</span> add-apt-repository <span class="token string">"deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> stable"</span>

<span class="token comment"># Step 4: 更新并安装 Docker-CE</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> -y update

<span class="token comment"># Step 5: 选择安装版本</span>
<span class="token function">apt-cache</span> madison docker-ce

<span class="token comment"># Step 6: 安装</span>
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token punctuation">\</span>
  containerd.io<span class="token operator">=</span><span class="token number">1.2</span>.10-3 <span class="token punctuation">\</span>
  docker-ce<span class="token operator">=</span><span class="token number">5</span>:19.03.4~3-0~ubuntu-<span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> <span class="token punctuation">\</span>
  docker-ce-cli<span class="token operator">=</span><span class="token number">5</span>:19.03.4~3-0~ubuntu-<span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span>  
</code></pre></div>
<h3 id="hash-后续操作">后续操作</h3>
<p><strong>1、当前用户加入"docker"用户组</strong></p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">usermod</span> -aG <span class="token function">docker</span> <span class="token environment constant">$USER</span>
</code></pre></div>
<p><strong>2、 配置 cgroup 驱动为 systemd，同时，增加 docker 仓库镜像配置。</strong></p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment">#  创建文件 /etc/docker/daemon.json ，内容如下：</span>
<span class="token punctuation">{</span>
  <span class="token string">"exec-opts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span>,
  <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"https://docker.mirrors.ustc.edu.cn/"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p><strong>3、重启服务生效配置</strong></p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart docker.service
</code></pre></div>
<p><strong>4、检查配置是否生效</strong></p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token function">docker</span> info <span class="token operator">|</span> <span class="token function">grep</span> Cgroup

<span class="token comment"># ECHO ------</span>
Cgroup Driver: systemd

</code></pre></div>
<h3 id="hash-关闭-swap">关闭 swap</h3>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">swapoff -a <span class="token operator">&#x26;&#x26;</span> <span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s/^.*swap/#&#x26;/g'</span> /etc/fstab
</code></pre></div>
<h3 id="hash-安装-kubelet-kubeadm-kubectl">安装 kubelet kubeadm kubectl</h3>
<p>由于网络原因，直接 APT-GET 安装可能安装不了，这里需要配置一下镜像仓库。</p>
<p><strong>1、配置阿里云 kubernetes 镜像仓库</strong></p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token operator">&#x26;&#x26;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y apt-transport-https

<span class="token function">curl</span> https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -
</code></pre></div>
<p><strong>2、创建文件 <code>/etc/apt/sources.list.d/kubernetes.list</code>， 内容如下：</strong></p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
</code></pre></div>
<p><strong>3、安装 kubelet kubectl kubeadm</strong></p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y kubelet kubeadm kubectl
</code></pre></div>
<p><strong>4、设置 kubelet 开机启动</strong></p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">$ <span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> kubelet
</code></pre></div>
<h2 id="hash-三、部署控制平面节点">三、部署控制平面节点</h2>
<p>过程中会用到一系列来自 Google 的 docker 镜像，可以通过 <code>kubeadm config images pull</code> 命令验证网络是否能够正常拉取镜像。如果无法访问，可从其他镜像仓库下载，然后再修改镜像标签，以启动相关 pod。</p>
<h3 id="hash-准备镜像">准备镜像</h3>
<p>列出安装过程中需要用到的镜像文件，命令为</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">kubeadm config images list

<span class="token comment"># ECHO ------</span>
k8s.gcr.io/kube-apiserver:v1.17.0
k8s.gcr.io/kube-controller-manager:v1.17.0
k8s.gcr.io/kube-scheduler:v1.17.0
k8s.gcr.io/kube-proxy:v1.17.0
k8s.gcr.io/pause:3.1
k8s.gcr.io/etcd:3.4.3-0
k8s.gcr.io/coredns:1.6.5
</code></pre></div>
<p>这里选择从 Docker hub 的 gotok8s 仓库拉取镜像副本，然后再修改 tag 名称，脚本如下：</p>
<div class="remark-highlight"><pre class="language-sh"><code class="language-sh">images=(kube-apiserver:v1.17.0 kube-controller-manager:v1.17.0 kube-scheduler:v1.17.0 kube-proxy:v1.17.0 pause:3.1 etcd:3.4.3-0 coredns:1.6.5)
for imageName in ${images[@]} ; do
  docker pull gotok8s/$imageName  
  docker tag gotok8s/$imageName k8s.gcr.io/$imageName  
  docker rmi gotok8s/$imageName
done
</code></pre></div>
<h3 id="hash-初始化控制平面节点">初始化控制平面节点</h3>
<p>控制平面节点是运行控制平面组件的机器，包括 etcd（集群数据库）和 API Server （kubectl CLI 与之通信）。</p>
<p>需要安装 Pod 网络插件，才能使得集群 Pod 间可以相互通信，必须在任何应用程序之前部署 Pod 网络。此外，CoreDNS 将不会在安装网络之前启动。kubeadm 仅支持基于容器网络接口（CNI）的网络，有几个项目使用 CNI 提供了 Kubernetes Pod 网络，其中一些还支持网络策略。有关可用的网络加载项列表，请参阅<a target="_blank" target="_blank" class="ext-link" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network">网络组件页面</a>。</p>
<p>另外，请注意，Pod 网络不得与任何主机网络重叠，因为这可能会导致问题。如果发现网络插件的首选 Pod 网络与某些主机网络之间发生冲突，在执行命令 kubeadm init 时应通过指定 --pod-network-cidr 参数配置网络，并在网络插件的 YAML 中修改相应信息。</p>
<p>这里选择 <code>calico</code> 网络插件，根据 Calico 文档说明，我们需为 <code>kubeadm init</code> 指定 <code>--pod-network-cidr=192.168.0.0/16</code> 参数。现在运行 <code>kubeadm init &#x3C;args> </code>，命令如下：</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> kubeadm init <span class="token punctuation">\</span>
    --kubernetes-version<span class="token operator">=</span>v1.17.0 <span class="token punctuation">\</span>
    --apiserver-advertise-address<span class="token operator">=</span><span class="token number">10.163</span>.10.6 <span class="token punctuation">\</span>
    --pod-network-cidr<span class="token operator">=</span><span class="token number">192.168</span>.0.0/16
</code></pre></div>
<p>如果一切正常，安装成功，将输入类似下面的结果信息：</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

You should now deploy a pod network to the cluster.
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> <span class="token number">10.163</span>.10.6:6443 --token xxxxxx.xxxxxxxxxxxxxxxx <span class="token punctuation">\</span>
    --discovery-token-ca-cert-hash sha256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</code></pre></div>
<p>根据提示消息，依次执行以下命令：</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
</code></pre></div>
<p>注意记录输出结果中的 <code>kubeadm join ***</code> 信息，随后在添加工作节点到集群时需要用到，可以复制后暂存在某个地方。</p>
<h3 id="hash-安装网络">安装网络</h3>
<p>此时，我们通过 <code>kubectl get pods --all-namespaces</code> 命令，应该可以看到 CoreDNS pod  处于 pending 状态，安装网络以后，它才能处于 running 状态。我们选择 calico 为 pod 提供网络，pod 网络组件本身以 k8s 应用的形式运行，执行下面命令进行安装。</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">kubectl apply -f https://docs.projectcalico.org/v3.11/manifests/calico.yaml
</code></pre></div>
<p>安装了 Pod 网络后，可以通过检查 CoreDNS Pod 的运行状态来确认它是否正常工作 <code>kubectl get pods --all-namespaces</code>。</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">kubectl get pods --all-namespaces

<span class="token comment"># ECHO ----</span>
NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE
kube-system   calico-kube-controllers-7bd78b474d-vmq2w   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m57s
kube-system   calico-node-2cwtx                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m57s
kube-system   coredns-5c98db65d4-gv2j6                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
kube-system   coredns-5c98db65d4-n6lpj                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
kube-system   etcd-vm-10-13-ubuntu                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m54s
kube-system   kube-apiserver-vm-10-13-ubuntu             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9m10s
kube-system   kube-controller-manager-vm-10-13-ubuntu    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9m3s
kube-system   kube-proxy-qbk66                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
kube-system   kube-scheduler-vm-10-13-ubuntu             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9m8s
</code></pre></div>
<p>pod 启动需要时间，请耐心等待。</p>
<h2 id="hash-四、加入工作节点">四、加入工作节点</h2>
<p>CoreDNS Pod 启动并运行后，我们可以为集群添加工作节点。工作节点服务器需安装 Docker 、kubeadm 和 kubelet，安装过程请参考前面相关小节。</p>
<h3 id="hash-拉取镜像">拉取镜像</h3>
<p>工作节点服务器需要至少启动两个 pod ，用到的镜像为 <code>kube-proxy</code> 和 <code>pause</code> ，同理我们无法直接从 k8s.grc.io 下载，需要提前拉取镜像并修改 tag ，执行下面命令：</p>
<div class="remark-highlight"><pre class="language-sh"><code class="language-sh">images=(kube-proxy:v1.17.0 pause:3.1)
for imageName in ${images[@]} ; do
  docker pull gotok8s/$imageName  
  docker tag gotok8s/$imageName k8s.gcr.io/$imageName  
  docker rmi gotok8s/$imageName
done
</code></pre></div>
<h3 id="hash-加入集群">加入集群</h3>
<p>执行控制平面节点初始化完成后提供的添加工作节点命令，格式如下：</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">kubeadm <span class="token function">join</span> --token <span class="token operator">&#x3C;</span>token<span class="token operator">></span> <span class="token operator">&#x3C;</span>master-ip<span class="token operator">></span>:<span class="token operator">&#x3C;</span>master-port<span class="token operator">></span> --discovery-token-ca-cert-hash sha256:<span class="token operator">&#x3C;</span>hash<span class="token operator">></span>
</code></pre></div>
<p>命令中的 <code>--token</code> 和 <code>--discovery-token-ca-cert-hash</code> 在集群 kube-apiserver 节点部署完成后的结果信息中有体现，直接复制出来即可使用。</p>
<p>可以通过在控制平面节点执行 <code>kubeadm token list</code> 来获取 token 信息，token 令牌会在 24 小时候失效，如果要创建新的令牌，使用 <code>kubeadm token create</code> 命令。</p>
<p>可以通过下面命令获取 <code>--discovery-token-ca-cert-hash</code></p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt <span class="token operator">|</span> openssl rsa -pubin -outform der <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> <span class="token punctuation">\</span>
   openssl dgst -sha256 -hex <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/^.* //'</span>
</code></pre></div>
<p>注意，如果需要重新执行 <code>kubeadm join</code> ，需在控制平面节点删除该节点 <code>kubectl delete node node-name</code>，并在工作节点上执行 <code>kubeadm reset</code> 进行清理工作。</p>
<p>节点执行完 join 命令后，可以在控制平面节点检查 pod 启动进度 <code>watch kubectl get pods --all-namespaces -o wide</code>，观察新节点服务器上的 Pod 状态，正常启动则加入成功且节点状态为 <code>Ready</code>。参照上述步骤，依次将所有工作节点加入集群。</p>
<h3 id="hash-检查工作节点状态">检查工作节点状态</h3>
<p>工作节点加入集群后，随着工作节点上相应 Pod 的正常启动，工作节点状态会由 <code>NotReady</code> 切换到 <code>Ready</code>，Pod 启动需要时间，请耐心等待。所有节点正常加入集群后，可以通过命令查看节点状态：</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">kubectl get nodes

<span class="token comment"># ECHO ------</span>
NAME              STATUS   ROLES    AGE    VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
vm-10-6-ubuntu    Ready    master   9h     v1.15.2   <span class="token number">10.163</span>.10.6    <span class="token operator">&#x3C;</span>none<span class="token operator">></span>        Ubuntu <span class="token number">18.04</span>.1 LTS   <span class="token number">4.15</span>.0-54-generic   docker://18.6.3
vm-10-7-ubuntu    Ready    <span class="token operator">&#x3C;</span>none<span class="token operator">></span>   9h     v1.15.2   <span class="token number">10.163</span>.10.7    <span class="token operator">&#x3C;</span>none<span class="token operator">></span>        Ubuntu <span class="token number">18.04</span>.1 LTS   <span class="token number">4.15</span>.0-54-generic   docker://18.6.3
vm-10-8-ubuntu    Ready    <span class="token operator">&#x3C;</span>none<span class="token operator">></span>   9h     v1.15.2   <span class="token number">10.163</span>.10.8    <span class="token operator">&#x3C;</span>none<span class="token operator">></span>        Ubuntu <span class="token number">18.04</span>.1 LTS   <span class="token number">4.15</span>.0-54-generic   docker://18.6.3
vm-10-9-ubuntu    Ready    <span class="token operator">&#x3C;</span>none<span class="token operator">></span>   8h     v1.15.2   <span class="token number">10.163</span>.10.9    <span class="token operator">&#x3C;</span>none<span class="token operator">></span>        Ubuntu <span class="token number">18.04</span>.1 LTS   <span class="token number">4.15</span>.0-54-generic   docker://18.6.3
vm-10-10-ubuntu   Ready    <span class="token operator">&#x3C;</span>none<span class="token operator">></span>   120m   v1.15.2   <span class="token number">10.163</span>.10.20   <span class="token operator">&#x3C;</span>none<span class="token operator">></span>        Ubuntu <span class="token number">18.04</span>.1 LTS   <span class="token number">4.15</span>.0-54-generic   docker://18.6.3
</code></pre></div>
<h2 id="hash-五、安装-Dashboard">五、安装 Dashboard</h2>
<p>Dashboard 不会随集群一起安装，需要单独部署，执行下面命令安装：</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-rc2/aio/deploy/recommended.yaml
</code></pre></div>
<p>这里要注意 Dashboard 的版本，并非所有版本的 Dashboard 都能和任意版本的 k8s 集群完全兼容。引用官网对照表</p>
<div class="table-responsive"><table>
<thead>
<tr>
<th>Kubernetes version</th>
<th>1.11</th>
<th>1.12</th>
<th>1.13</th>
<th>1.14</th>
<th>1.15</th>
<th>1.16</th>
</tr>
</thead>
<tbody>
<tr>
<td>Compatibility</td>
<td>?</td>
<td>?</td>
<td>?</td>
<td>?</td>
<td>?</td>
<td>✓</td>
</tr>
</tbody>
</table></div>
<ul>
<li><strong>✓</strong> 完全支持。</li>
<li><strong>?</strong> 由于 Kubernetes API 版本之间的变化，部分功能无法正确地在 Dashboard 中工作。</li>
</ul>
<p>默认情况下，Dashboard 使用最小 RBAC 配置进行部署。目前，Dashboard 仅支持使用 Bearer Token 登录。可以按照<a target="_blank" target="_blank" class="ext-link" href="https://github.com/kubernetes/dashboard/wiki/Creating-sample-user">关于创建示例用户的指南</a> 进行操作。</p>
<p>关于 Dashboard 的使用，随后会抽时间再详细写一篇进行介绍。</p>
<h2 id="hash-六、Inress-nginx">六、Inress-nginx</h2>
<ol>
<li>
<p>选择一个节点，打上 <code>node.k8s.xx.cn/role: ingress</code> 标签，以便于下一步进行 Pod 调度。</p>
</li>
<li>
<p>下载 ingress-nginx 资源信息</p>
</li>
</ol>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token function">wget</span> https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml
<span class="token function">wget</span> https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/baremetal/service-nodeport.yaml
</code></pre></div>
<ol>
<li>修改配置信息</li>
</ol>
<p>修改 ingress-nginx 安装文件 <code>mandatory.yaml</code>，以确保 nginx-ingress-controller 运行在指定节点上。</p>
<div class="remark-highlight"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">...</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
        <span class="token key atrule">node.k8s.xx.cn/role</span><span class="token punctuation">:</span> ingress
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>serviceaccount
<span class="token punctuation">...</span>
</code></pre></div>
<p>配置 service 为集群 IP 类型，并配置 <code>externalIPs</code> 以对外暴露服务。</p>
<div class="remark-highlight"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">externalIPs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> 10.163.10.7
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token punctuation">---</span>
</code></pre></div>
<ol>
<li>安装 ingress-nginx</li>
</ol>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">kubectl apply -f mandatory.yaml
kubectl apply -f service-nodeport.yaml
</code></pre></div>
<h2 id="hash-七、访问-Dashboard">七、访问 Dashboard</h2>
<p>现在有了 Dashboard 和 Ingress 我们可以通过一些简单的配置使 dashbaord 可从外部访问。</p>
<p><strong>1、创建 Service 以将外部流量倒向 Dashboard</strong></p>
<div class="remark-highlight"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8443</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None
</code></pre></div>
<p><strong>2、创建存储 TLS 数字证书的 Secret</strong></p>
<p>Dashboard 只能通过 HTTPS 访问，我们需要准备一个域名并为其签发数字证书。以 <code>www.yourdomain.com</code> 域名为例，在命名空间 <code>kubernetes-dashboard</code> 创建 Secret。</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">kubectl create secret tls cloud.jfjbapp.cn --cert<span class="token operator">=</span><span class="token environment constant">$HOME</span>/certs/dashboard.crt --key<span class="token operator">=</span><span class="token environment constant">$HOME</span>/certs/dashboard.key -n kubernetes-dashboard
</code></pre></div>
<p><strong>3、创建 Ingerss 将外部流量倒入集群</strong></p>
<div class="remark-highlight"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>ingress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/backend-protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation">:</span> /$2
    <span class="token key atrule">nginx.ingress.kubernetes.io/use-regex</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> www.yourdomain.com
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> www.yourdomain.com
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> www.yourdomain.com
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /kube(/<span class="token punctuation">|</span>$)(.<span class="token important">*)</span>
            <span class="token key atrule">backend</span><span class="token punctuation">:</span>
              <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
              <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">443</span>
</code></pre></div>
<p>浏览器访问 <a target="_blank" target="_blank" class="ext-link" href="https://www.yourdomain.com/kube/%EF%BC%8C%E8%BE%93%E5%85%A5%E7%99%BB%E9%99%86%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%8D%B3%E5%8F%AF%E6%AD%A3%E5%B8%B8%E4%BD%BF%E7%94%A8">https://www.yourdomain.com/kube/，输入登陆信息，即可正常使用</a> Kubernetes Dashboard 。</p>
<h2 id="hash-八、完成">八、完成</h2>
<p>现在我们已经拥有一个 4 工作节点的单控制平面 k8s 集群，本文仅简单介绍了部署过程，关于集群的管理、使用还会涉及到非常多 k8s 概念及领域知识，官网文档基本上很详细的介绍了各类概念，还有详尽的操作演示，可以多看、多实践。</p>
</article><div class="flex flex-wrap items-center md:space-x-2 my-24 pt-8 border-t border-solid border-gray-100 dark:border-gray-600"><div class="font-bold text-black text-base dark:text-white "><strong>标签：</strong></div><div class="text-blue-600 flex text-sm flex-wrap dark:text-slate-400"><a class="mr-4 hover:underline" href="/tags/kubernetes/">KUBERNETES</a><a class="mr-4 hover:underline" href="/tags/docker/">DOCKER</a><a class="mr-4 hover:underline" href="/tags/dashboard/">DASHBOARD</a><a class="mr-4 hover:underline" href="/tags/ingress-nginx/">INGRESS-NGINX</a></div></div><div class="next-and-prev-post"><a class="prev-post" href="/blogs/2020/microservice-api-gateway-krakend/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"></path></svg><div class="text"><div class="caption">2020-01-11 15:28:13</div><div class="title">微服务 API 网关 KrakenD</div></div></a><a class="next-post" href="/blogs/2020/how-to-install-java-with-apt-get-on-ubuntu/"><div class="text"><div class="caption">2020-01-21 00:20:08</div><div class="title">Ubuntu 18.04 安装 Java 环境 - OpenJDK</div></div><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"></path></svg></a></div></div><div class="hidden xl:block xl:basis-1/6 shrink-0 relative "></div></div><button class="z-50 hidden md:flex scroll-to-top rounded-full whitespace-nowrap space-x-2 flex-row text-xs items-center uppercase py-2 px-5 text-white bg-blue-600 hover:bg-gray-800 transition"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 10a.5.5 0 0 0 .5-.5V3.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 3.707V9.5a.5.5 0 0 0 .5.5zm-7 2.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5z"></path></svg><span>Scroll to top</span></button></main><footer class="border-t dark:border-gray-700"><div class="container mx-auto pt-12 pb-20 opacity-50 hover:opacity-100 transition duration-500"><div class="flex flex-row justify-center items-center space-x-5"><a class="flex justify-center text-blue-500 w-8 h-8" href="/"><svg viewBox="0 0 512 512" fill="currentColor"><path d="M238.74,366.17c-24.56,0.42-12.59,0.42-36.76,0 C92.86,358.74,92.54,257.24,92.54,257.24s-3.78-104.91,109.44-110.42c105.79,0.4,195.22,0.23,242.54,0.08 c40.86-0.53,36.61-7.61,26.7-24.61C447.75,81.99,384.8,3.28,250.71,0C-60.02,17.45-88.35,433.93,194.97,504.76 c42.5,12.75,91.65,4.77,91.65,4.77s-0.23-52.54,0-94.13C286.82,378.65,274.71,365.55,238.74,366.17z M482.55,207.28 c-12,0.02-229.21,1.03-280.57,0.86c-48.75-0.16-48.73,49.23-48.73,49.23s0.19,47.49,48.73,47.5c-0.03,0,109.56-0.35,121.41,0 c11.91,0.35,24.03,12.59,23.94,25.04c-0.19,27.35,0.46,163.59,0.64,163.53c24.08-8.5,157.24-66.58,161.49-236.57 C510.08,231.99,506.75,207.3,482.55,207.28z"></path></svg></a><code class=" text-xs font-mono text-gray-500">$ echo &quot;simple things scale.&quot; </code></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":["posts","2020","creating-single-control-plane-cluster-with-kubeadm"],"post":{"id":["posts","2020","creating-single-control-plane-cluster-with-kubeadm"],"contentHtml":"\u003cdiv class=\"image-widget\"\u003e\u003cimg src=\"/attachments/posts/2020/creating-single-control-plane-cluster-with-kubeadm.files/cover.png\" alt=\"部署单控制平面 k8s 集群，并安装 Dashboard 和 ingress-nginx 使外部浏览器可以访问集群。\"\u003e\u003cdiv class=\"figcaption\"\u003e部署单控制平面 k8s 集群，并安装 Dashboard 和 ingress-nginx 使外部浏览器可以访问集群。\u003c/div\u003e\u003c/div\u003e\n\u003ch2 id=\"hash-一、拓扑结构\"\u003e一、拓扑结构\u003c/h2\u003e\n\u003cp\u003e本文主要介绍如何使用 kubeadm 安装部署单控制平面 Kubernetes v1.17.0 集群，所谓单控制平面，顾名思义就是由一个 Control-plane Node 和多个 Work Node 组成的 Kubernetes 集群。高可用集群与此不同，其由多个 Control-plane Node 和多个 Work Node 组成，高可用集群部署中，根据 etcd 数据库部署位置的不同，又分为栈内 etcd 数据库部署和外部独立 etcd 数据库集群部署两种模式。\n下面展示了不同部署模式的拓扑结构：\u003c/p\u003e\n\u003cdiv class=\"image-widget\"\u003e\u003cimg src=\"/attachments/posts/2020/creating-single-control-plane-cluster-with-kubeadm.files/kubeadm-scp-topology.svg\" alt=\"单控制平面拓扑结构\"\u003e\u003cdiv class=\"figcaption\"\u003e单控制平面拓扑结构\u003c/div\u003e\u003c/div\u003e\n\u003cdiv class=\"image-widget\"\u003e\u003cimg src=\"/attachments/posts/2020/creating-single-control-plane-cluster-with-kubeadm.files/kubeadm-ha-topology-stacked-etcd.svg\" alt=\"高可用拓扑结构（栈内 etcd 数据库）\"\u003e\u003cdiv class=\"figcaption\"\u003e高可用拓扑结构（栈内 etcd 数据库）\u003c/div\u003e\u003c/div\u003e\n\u003cdiv class=\"image-widget\"\u003e\u003cimg src=\"/attachments/posts/2020/creating-single-control-plane-cluster-with-kubeadm.files/kubeadm-ha-topology-external-etcd.svg\" alt=\"高可用拓扑结构（外部独立 etcd 数据库集群）\"\u003e\u003cdiv class=\"figcaption\"\u003e高可用拓扑结构（外部独立 etcd 数据库集群）\u003c/div\u003e\u003c/div\u003e\n\u003cp\u003e高可用部署与单控制平面部署不同，不过，除负载均衡及多 kube-apiserver 部分外，其他流程大同小异。有关高可用安装的更多信息请参考 \u003ca target=\"_blank\" target=\"_blank\" class=\"ext-link\" href=\"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/\"\u003eCreating Highly Available clusters with kubeadm\u003c/a\u003e。\u003c/p\u003e\n\u003ch2 id=\"hash-二、准备工作\"\u003e二、准备工作\u003c/h2\u003e\n\u003cp\u003e硬件要求，建议 4 核以上 CPU，8GB 以上内存，Ubuntu 16.04 以上或 CentOS 7 以上版本的操作系统，确保所有服务器间网络通信正常，1 台服务器作为控制平面节点，其余若干台服务器作为工作节点，我这里准备了4个工作节点。基本信息如下：\u003c/p\u003e\n\u003cdiv class=\"table-responsive\"\u003e\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e名称\u003c/th\u003e\n\u003cth\u003eCPU\u003c/th\u003e\n\u003cth\u003e内存\u003c/th\u003e\n\u003cth\u003eIP\u003c/th\u003e\n\u003cth\u003eOS\u003c/th\u003e\n\u003cth\u003e安装\u003c/th\u003e\n\u003cth\u003e用途\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eCPN-1\u003c/td\u003e\n\u003ctd\u003e4U\u003c/td\u003e\n\u003ctd\u003e8GB\u003c/td\u003e\n\u003ctd\u003e10.163.10.6\u003c/td\u003e\n\u003ctd\u003eubuntu18.04\u003c/td\u003e\n\u003ctd\u003edocker , kubeadm, kubelet , kubectl\u003c/td\u003e\n\u003ctd\u003eControl Plane Node\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eWN-1\u003c/td\u003e\n\u003ctd\u003e4U\u003c/td\u003e\n\u003ctd\u003e8GB\u003c/td\u003e\n\u003ctd\u003e10.163.10.7\u003c/td\u003e\n\u003ctd\u003eubuntu18.04\u003c/td\u003e\n\u003ctd\u003edocker , kubeadm, kubelet\u003c/td\u003e\n\u003ctd\u003eWorker Node\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eWN-2\u003c/td\u003e\n\u003ctd\u003e4U\u003c/td\u003e\n\u003ctd\u003e8GB\u003c/td\u003e\n\u003ctd\u003e10.163.10.8\u003c/td\u003e\n\u003ctd\u003eubuntu18.04\u003c/td\u003e\n\u003ctd\u003edocker , kubeadm, kubelet\u003c/td\u003e\n\u003ctd\u003eWorker Node\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eWN-2\u003c/td\u003e\n\u003ctd\u003e4U\u003c/td\u003e\n\u003ctd\u003e8GB\u003c/td\u003e\n\u003ctd\u003e10.163.10.9\u003c/td\u003e\n\u003ctd\u003eubuntu18.04\u003c/td\u003e\n\u003ctd\u003edocker , kubeadm, kubelet\u003c/td\u003e\n\u003ctd\u003eWorker Node\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eWN-2\u003c/td\u003e\n\u003ctd\u003e4U\u003c/td\u003e\n\u003ctd\u003e8GB\u003c/td\u003e\n\u003ctd\u003e10.163.10.10\u003c/td\u003e\n\u003ctd\u003eubuntu18.04\u003c/td\u003e\n\u003ctd\u003edocker , kubeadm, kubelet\u003c/td\u003e\n\u003ctd\u003eWorker Node\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-安装-docker\"\u003e安装 docker\u003c/h3\u003e\n\u003cp\u003eK8S 支持多种容器运行时环境，我们选择 docker，首先为所有节点服务器安装 docker，目前 kubernetes 最新版(v1.17.0) 可以完全兼容支持的 docker 最高版本为 v19.03，我们选择 Docker 的最新稳定版本 v19.03 作为容器运行时环境。安装细节可参考 \u003ca target=\"_blank\" target=\"_blank\" class=\"ext-link\" href=\"https://docs.docker.com/install/linux/docker-ce/ubuntu/\"\u003eGet Docker Engine - Community for Ubuntu\u003c/a\u003e。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# 删除旧版本docker\u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e remove \u003cspan class=\"token function\"\u003edocker\u003c/span\u003e docker-engine docker.io containerd runc\n\n\u003cspan class=\"token comment\"\u003e# 更新 apt \u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e update\n\n\u003cspan class=\"token comment\"\u003e# 安装工具包\u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    apt-transport-https \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    ca-certificates \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003ecurl\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    gnupg-agent \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    software-properties-common\n\n\u003cspan class=\"token comment\"\u003e# 添加Docker官方 GPG key\u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003ecurl\u003c/span\u003e -fsSL https://download.docker.com/linux/ubuntu/gpg \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e apt-key \u003cspan class=\"token function\"\u003eadd\u003c/span\u003e -\n\n\u003cspan class=\"token comment\"\u003e# 添加 stable apt 源\u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e add-apt-repository \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n   \u003cspan class=\"token string\"\u003e\"deb [arch=amd64] https://download.docker.com/linux/ubuntu \\\n   \u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003elsb_release -cs\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e \\\n   stable\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# 安装 Docker CE\u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e update\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  containerd.io\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1.2\u003c/span\u003e.10-3 \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  docker-ce\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e5\u003c/span\u003e:19.03.4~3-0~ubuntu-\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003elsb_release -cs\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  docker-ce-cli\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e5\u003c/span\u003e:19.03.4~3-0~ubuntu-\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003elsb_release -cs\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e如果你的网络环境从官方仓库安装速度较慢，可以使用阿里云镜像仓库安装。步骤如下：\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# step 1: 安装必要的一些系统工具\u003c/span\u003e\n\u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e update\n\u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e -y \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e apt-transport-https ca-certificates \u003cspan class=\"token function\"\u003ecurl\u003c/span\u003e software-properties-common\n\n\u003cspan class=\"token comment\"\u003e# step 2: 安装GPG证书\u003c/span\u003e\n\u003cspan class=\"token function\"\u003ecurl\u003c/span\u003e -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e apt-key \u003cspan class=\"token function\"\u003eadd\u003c/span\u003e -\n\n\u003cspan class=\"token comment\"\u003e# Step 3: 写入软件源信息\u003c/span\u003e\n\u003cspan class=\"token function\"\u003esudo\u003c/span\u003e add-apt-repository \u003cspan class=\"token string\"\u003e\"deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu \u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003elsb_release -cs\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e stable\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Step 4: 更新并安装 Docker-CE\u003c/span\u003e\n\u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e -y update\n\n\u003cspan class=\"token comment\"\u003e# Step 5: 选择安装版本\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eapt-cache\u003c/span\u003e madison docker-ce\n\n\u003cspan class=\"token comment\"\u003e# Step 6: 安装\u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e update\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  containerd.io\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1.2\u003c/span\u003e.10-3 \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  docker-ce\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e5\u003c/span\u003e:19.03.4~3-0~ubuntu-\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003elsb_release -cs\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  docker-ce-cli\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e5\u003c/span\u003e:19.03.4~3-0~ubuntu-\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003elsb_release -cs\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e  \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-后续操作\"\u003e后续操作\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e1、当前用户加入\"docker\"用户组\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eusermod\u003c/span\u003e -aG \u003cspan class=\"token function\"\u003edocker\u003c/span\u003e \u003cspan class=\"token environment constant\"\u003e$USER\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e2、 配置 cgroup 驱动为 systemd，同时，增加 docker 仓库镜像配置。\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e#  创建文件 /etc/docker/daemon.json ，内容如下：\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token string\"\u003e\"exec-opts\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"native.cgroupdriver=systemd\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e,\n  \u003cspan class=\"token string\"\u003e\"registry-mirrors\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"https://docker.mirrors.ustc.edu.cn/\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e3、重启服务生效配置\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token function\"\u003esudo\u003c/span\u003e systemctl daemon-reload\n\u003cspan class=\"token function\"\u003esudo\u003c/span\u003e systemctl restart docker.service\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e4、检查配置是否生效\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token function\"\u003edocker\u003c/span\u003e info \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003egrep\u003c/span\u003e Cgroup\n\n\u003cspan class=\"token comment\"\u003e# ECHO ------\u003c/span\u003e\nCgroup Driver: systemd\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-关闭-swap\"\u003e关闭 swap\u003c/h3\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eswapoff -a \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003esed\u003c/span\u003e -i \u003cspan class=\"token string\"\u003e's/^.*swap/#\u0026#x26;/g'\u003c/span\u003e /etc/fstab\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-安装-kubelet-kubeadm-kubectl\"\u003e安装 kubelet kubeadm kubectl\u003c/h3\u003e\n\u003cp\u003e由于网络原因，直接 APT-GET 安装可能安装不了，这里需要配置一下镜像仓库。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1、配置阿里云 kubernetes 镜像仓库\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e update \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e -y apt-transport-https\n\n\u003cspan class=\"token function\"\u003ecurl\u003c/span\u003e https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e apt-key \u003cspan class=\"token function\"\u003eadd\u003c/span\u003e -\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e2、创建文件 \u003ccode\u003e/etc/apt/sources.list.d/kubernetes.list\u003c/code\u003e， 内容如下：\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003edeb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e3、安装 kubelet kubectl kubeadm\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e update\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e -y kubelet kubeadm kubectl\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e4、设置 kubelet 开机启动\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e systemctl \u003cspan class=\"token builtin class-name\"\u003eenable\u003c/span\u003e kubelet\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"hash-三、部署控制平面节点\"\u003e三、部署控制平面节点\u003c/h2\u003e\n\u003cp\u003e过程中会用到一系列来自 Google 的 docker 镜像，可以通过 \u003ccode\u003ekubeadm config images pull\u003c/code\u003e 命令验证网络是否能够正常拉取镜像。如果无法访问，可从其他镜像仓库下载，然后再修改镜像标签，以启动相关 pod。\u003c/p\u003e\n\u003ch3 id=\"hash-准备镜像\"\u003e准备镜像\u003c/h3\u003e\n\u003cp\u003e列出安装过程中需要用到的镜像文件，命令为\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ekubeadm config images list\n\n\u003cspan class=\"token comment\"\u003e# ECHO ------\u003c/span\u003e\nk8s.gcr.io/kube-apiserver:v1.17.0\nk8s.gcr.io/kube-controller-manager:v1.17.0\nk8s.gcr.io/kube-scheduler:v1.17.0\nk8s.gcr.io/kube-proxy:v1.17.0\nk8s.gcr.io/pause:3.1\nk8s.gcr.io/etcd:3.4.3-0\nk8s.gcr.io/coredns:1.6.5\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e这里选择从 Docker hub 的 gotok8s 仓库拉取镜像副本，然后再修改 tag 名称，脚本如下：\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-sh\"\u003e\u003ccode class=\"language-sh\"\u003eimages=(kube-apiserver:v1.17.0 kube-controller-manager:v1.17.0 kube-scheduler:v1.17.0 kube-proxy:v1.17.0 pause:3.1 etcd:3.4.3-0 coredns:1.6.5)\nfor imageName in ${images[@]} ; do\n  docker pull gotok8s/$imageName  \n  docker tag gotok8s/$imageName k8s.gcr.io/$imageName  \n  docker rmi gotok8s/$imageName\ndone\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-初始化控制平面节点\"\u003e初始化控制平面节点\u003c/h3\u003e\n\u003cp\u003e控制平面节点是运行控制平面组件的机器，包括 etcd（集群数据库）和 API Server （kubectl CLI 与之通信）。\u003c/p\u003e\n\u003cp\u003e需要安装 Pod 网络插件，才能使得集群 Pod 间可以相互通信，必须在任何应用程序之前部署 Pod 网络。此外，CoreDNS 将不会在安装网络之前启动。kubeadm 仅支持基于容器网络接口（CNI）的网络，有几个项目使用 CNI 提供了 Kubernetes Pod 网络，其中一些还支持网络策略。有关可用的网络加载项列表，请参阅\u003ca target=\"_blank\" target=\"_blank\" class=\"ext-link\" href=\"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network\"\u003e网络组件页面\u003c/a\u003e。\u003c/p\u003e\n\u003cp\u003e另外，请注意，Pod 网络不得与任何主机网络重叠，因为这可能会导致问题。如果发现网络插件的首选 Pod 网络与某些主机网络之间发生冲突，在执行命令 kubeadm init 时应通过指定 --pod-network-cidr 参数配置网络，并在网络插件的 YAML 中修改相应信息。\u003c/p\u003e\n\u003cp\u003e这里选择 \u003ccode\u003ecalico\u003c/code\u003e 网络插件，根据 Calico 文档说明，我们需为 \u003ccode\u003ekubeadm init\u003c/code\u003e 指定 \u003ccode\u003e--pod-network-cidr=192.168.0.0/16\u003c/code\u003e 参数。现在运行 \u003ccode\u003ekubeadm init \u0026#x3C;args\u003e \u003c/code\u003e，命令如下：\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token function\"\u003esudo\u003c/span\u003e kubeadm init \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    --kubernetes-version\u003cspan class=\"token operator\"\u003e=\u003c/span\u003ev1.17.0 \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    --apiserver-advertise-address\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e10.163\u003c/span\u003e.10.6 \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    --pod-network-cidr\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e192.168\u003c/span\u003e.0.0/16\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e如果一切正常，安装成功，将输入类似下面的结果信息：\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eYour Kubernetes control-plane has initialized successfully\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  \u003cspan class=\"token function\"\u003emkdir\u003c/span\u003e -p \u003cspan class=\"token environment constant\"\u003e$HOME\u003c/span\u003e/.kube\n  \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003ecp\u003c/span\u003e -i /etc/kubernetes/admin.conf \u003cspan class=\"token environment constant\"\u003e$HOME\u003c/span\u003e/.kube/config\n  \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003echown\u003c/span\u003e \u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003eid\u003c/span\u003e -u\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003eid\u003c/span\u003e -g\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token environment constant\"\u003e$HOME\u003c/span\u003e/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun \u003cspan class=\"token string\"\u003e\"kubectl apply -f [podnetwork].yaml\"\u003c/span\u003e with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can \u003cspan class=\"token function\"\u003ejoin\u003c/span\u003e any number of worker nodes by running the following on each as root:\n\nkubeadm \u003cspan class=\"token function\"\u003ejoin\u003c/span\u003e \u003cspan class=\"token number\"\u003e10.163\u003c/span\u003e.10.6:6443 --token xxxxxx.xxxxxxxxxxxxxxxx \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    --discovery-token-ca-cert-hash sha256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e根据提示消息，依次执行以下命令：\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token function\"\u003emkdir\u003c/span\u003e -p \u003cspan class=\"token environment constant\"\u003e$HOME\u003c/span\u003e/.kube\n  \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003ecp\u003c/span\u003e -i /etc/kubernetes/admin.conf \u003cspan class=\"token environment constant\"\u003e$HOME\u003c/span\u003e/.kube/config\n  \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003echown\u003c/span\u003e \u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003eid\u003c/span\u003e -u\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token function\"\u003eid\u003c/span\u003e -g\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token environment constant\"\u003e$HOME\u003c/span\u003e/.kube/config\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e注意记录输出结果中的 \u003ccode\u003ekubeadm join ***\u003c/code\u003e 信息，随后在添加工作节点到集群时需要用到，可以复制后暂存在某个地方。\u003c/p\u003e\n\u003ch3 id=\"hash-安装网络\"\u003e安装网络\u003c/h3\u003e\n\u003cp\u003e此时，我们通过 \u003ccode\u003ekubectl get pods --all-namespaces\u003c/code\u003e 命令，应该可以看到 CoreDNS pod  处于 pending 状态，安装网络以后，它才能处于 running 状态。我们选择 calico 为 pod 提供网络，pod 网络组件本身以 k8s 应用的形式运行，执行下面命令进行安装。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ekubectl apply -f https://docs.projectcalico.org/v3.11/manifests/calico.yaml\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e安装了 Pod 网络后，可以通过检查 CoreDNS Pod 的运行状态来确认它是否正常工作 \u003ccode\u003ekubectl get pods --all-namespaces\u003c/code\u003e。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ekubectl get pods --all-namespaces\n\n\u003cspan class=\"token comment\"\u003e# ECHO ----\u003c/span\u003e\nNAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE\nkube-system   calico-kube-controllers-7bd78b474d-vmq2w   \u003cspan class=\"token number\"\u003e1\u003c/span\u003e/1     Running   \u003cspan class=\"token number\"\u003e0\u003c/span\u003e          4m57s\nkube-system   calico-node-2cwtx                          \u003cspan class=\"token number\"\u003e1\u003c/span\u003e/1     Running   \u003cspan class=\"token number\"\u003e0\u003c/span\u003e          4m57s\nkube-system   coredns-5c98db65d4-gv2j6                   \u003cspan class=\"token number\"\u003e1\u003c/span\u003e/1     Running   \u003cspan class=\"token number\"\u003e0\u003c/span\u003e          10m\nkube-system   coredns-5c98db65d4-n6lpj                   \u003cspan class=\"token number\"\u003e1\u003c/span\u003e/1     Running   \u003cspan class=\"token number\"\u003e0\u003c/span\u003e          10m\nkube-system   etcd-vm-10-13-ubuntu                       \u003cspan class=\"token number\"\u003e1\u003c/span\u003e/1     Running   \u003cspan class=\"token number\"\u003e0\u003c/span\u003e          8m54s\nkube-system   kube-apiserver-vm-10-13-ubuntu             \u003cspan class=\"token number\"\u003e1\u003c/span\u003e/1     Running   \u003cspan class=\"token number\"\u003e0\u003c/span\u003e          9m10s\nkube-system   kube-controller-manager-vm-10-13-ubuntu    \u003cspan class=\"token number\"\u003e1\u003c/span\u003e/1     Running   \u003cspan class=\"token number\"\u003e0\u003c/span\u003e          9m3s\nkube-system   kube-proxy-qbk66                           \u003cspan class=\"token number\"\u003e1\u003c/span\u003e/1     Running   \u003cspan class=\"token number\"\u003e0\u003c/span\u003e          10m\nkube-system   kube-scheduler-vm-10-13-ubuntu             \u003cspan class=\"token number\"\u003e1\u003c/span\u003e/1     Running   \u003cspan class=\"token number\"\u003e0\u003c/span\u003e          9m8s\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003epod 启动需要时间，请耐心等待。\u003c/p\u003e\n\u003ch2 id=\"hash-四、加入工作节点\"\u003e四、加入工作节点\u003c/h2\u003e\n\u003cp\u003eCoreDNS Pod 启动并运行后，我们可以为集群添加工作节点。工作节点服务器需安装 Docker 、kubeadm 和 kubelet，安装过程请参考前面相关小节。\u003c/p\u003e\n\u003ch3 id=\"hash-拉取镜像\"\u003e拉取镜像\u003c/h3\u003e\n\u003cp\u003e工作节点服务器需要至少启动两个 pod ，用到的镜像为 \u003ccode\u003ekube-proxy\u003c/code\u003e 和 \u003ccode\u003epause\u003c/code\u003e ，同理我们无法直接从 k8s.grc.io 下载，需要提前拉取镜像并修改 tag ，执行下面命令：\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-sh\"\u003e\u003ccode class=\"language-sh\"\u003eimages=(kube-proxy:v1.17.0 pause:3.1)\nfor imageName in ${images[@]} ; do\n  docker pull gotok8s/$imageName  \n  docker tag gotok8s/$imageName k8s.gcr.io/$imageName  \n  docker rmi gotok8s/$imageName\ndone\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-加入集群\"\u003e加入集群\u003c/h3\u003e\n\u003cp\u003e执行控制平面节点初始化完成后提供的添加工作节点命令，格式如下：\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ekubeadm \u003cspan class=\"token function\"\u003ejoin\u003c/span\u003e --token \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003etoken\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003emaster-ip\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e:\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003emaster-port\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e --discovery-token-ca-cert-hash sha256:\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003ehash\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e命令中的 \u003ccode\u003e--token\u003c/code\u003e 和 \u003ccode\u003e--discovery-token-ca-cert-hash\u003c/code\u003e 在集群 kube-apiserver 节点部署完成后的结果信息中有体现，直接复制出来即可使用。\u003c/p\u003e\n\u003cp\u003e可以通过在控制平面节点执行 \u003ccode\u003ekubeadm token list\u003c/code\u003e 来获取 token 信息，token 令牌会在 24 小时候失效，如果要创建新的令牌，使用 \u003ccode\u003ekubeadm token create\u003c/code\u003e 命令。\u003c/p\u003e\n\u003cp\u003e可以通过下面命令获取 \u003ccode\u003e--discovery-token-ca-cert-hash\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eopenssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e openssl rsa -pubin -outform der \u003cspan class=\"token operator\"\u003e\u003cspan class=\"token file-descriptor important\"\u003e2\u003c/span\u003e\u003e\u003c/span\u003e/dev/null \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n   openssl dgst -sha256 -hex \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003esed\u003c/span\u003e \u003cspan class=\"token string\"\u003e's/^.* //'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e注意，如果需要重新执行 \u003ccode\u003ekubeadm join\u003c/code\u003e ，需在控制平面节点删除该节点 \u003ccode\u003ekubectl delete node node-name\u003c/code\u003e，并在工作节点上执行 \u003ccode\u003ekubeadm reset\u003c/code\u003e 进行清理工作。\u003c/p\u003e\n\u003cp\u003e节点执行完 join 命令后，可以在控制平面节点检查 pod 启动进度 \u003ccode\u003ewatch kubectl get pods --all-namespaces -o wide\u003c/code\u003e，观察新节点服务器上的 Pod 状态，正常启动则加入成功且节点状态为 \u003ccode\u003eReady\u003c/code\u003e。参照上述步骤，依次将所有工作节点加入集群。\u003c/p\u003e\n\u003ch3 id=\"hash-检查工作节点状态\"\u003e检查工作节点状态\u003c/h3\u003e\n\u003cp\u003e工作节点加入集群后，随着工作节点上相应 Pod 的正常启动，工作节点状态会由 \u003ccode\u003eNotReady\u003c/code\u003e 切换到 \u003ccode\u003eReady\u003c/code\u003e，Pod 启动需要时间，请耐心等待。所有节点正常加入集群后，可以通过命令查看节点状态：\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ekubectl get nodes\n\n\u003cspan class=\"token comment\"\u003e# ECHO ------\u003c/span\u003e\nNAME              STATUS   ROLES    AGE    VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME\nvm-10-6-ubuntu    Ready    master   9h     v1.15.2   \u003cspan class=\"token number\"\u003e10.163\u003c/span\u003e.10.6    \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003enone\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e        Ubuntu \u003cspan class=\"token number\"\u003e18.04\u003c/span\u003e.1 LTS   \u003cspan class=\"token number\"\u003e4.15\u003c/span\u003e.0-54-generic   docker://18.6.3\nvm-10-7-ubuntu    Ready    \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003enone\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e   9h     v1.15.2   \u003cspan class=\"token number\"\u003e10.163\u003c/span\u003e.10.7    \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003enone\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e        Ubuntu \u003cspan class=\"token number\"\u003e18.04\u003c/span\u003e.1 LTS   \u003cspan class=\"token number\"\u003e4.15\u003c/span\u003e.0-54-generic   docker://18.6.3\nvm-10-8-ubuntu    Ready    \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003enone\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e   9h     v1.15.2   \u003cspan class=\"token number\"\u003e10.163\u003c/span\u003e.10.8    \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003enone\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e        Ubuntu \u003cspan class=\"token number\"\u003e18.04\u003c/span\u003e.1 LTS   \u003cspan class=\"token number\"\u003e4.15\u003c/span\u003e.0-54-generic   docker://18.6.3\nvm-10-9-ubuntu    Ready    \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003enone\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e   8h     v1.15.2   \u003cspan class=\"token number\"\u003e10.163\u003c/span\u003e.10.9    \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003enone\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e        Ubuntu \u003cspan class=\"token number\"\u003e18.04\u003c/span\u003e.1 LTS   \u003cspan class=\"token number\"\u003e4.15\u003c/span\u003e.0-54-generic   docker://18.6.3\nvm-10-10-ubuntu   Ready    \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003enone\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e   120m   v1.15.2   \u003cspan class=\"token number\"\u003e10.163\u003c/span\u003e.10.20   \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003enone\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e        Ubuntu \u003cspan class=\"token number\"\u003e18.04\u003c/span\u003e.1 LTS   \u003cspan class=\"token number\"\u003e4.15\u003c/span\u003e.0-54-generic   docker://18.6.3\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"hash-五、安装-Dashboard\"\u003e五、安装 Dashboard\u003c/h2\u003e\n\u003cp\u003eDashboard 不会随集群一起安装，需要单独部署，执行下面命令安装：\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ekubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-rc2/aio/deploy/recommended.yaml\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e这里要注意 Dashboard 的版本，并非所有版本的 Dashboard 都能和任意版本的 k8s 集群完全兼容。引用官网对照表\u003c/p\u003e\n\u003cdiv class=\"table-responsive\"\u003e\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eKubernetes version\u003c/th\u003e\n\u003cth\u003e1.11\u003c/th\u003e\n\u003cth\u003e1.12\u003c/th\u003e\n\u003cth\u003e1.13\u003c/th\u003e\n\u003cth\u003e1.14\u003c/th\u003e\n\u003cth\u003e1.15\u003c/th\u003e\n\u003cth\u003e1.16\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eCompatibility\u003c/td\u003e\n\u003ctd\u003e?\u003c/td\u003e\n\u003ctd\u003e?\u003c/td\u003e\n\u003ctd\u003e?\u003c/td\u003e\n\u003ctd\u003e?\u003c/td\u003e\n\u003ctd\u003e?\u003c/td\u003e\n\u003ctd\u003e✓\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e✓\u003c/strong\u003e 完全支持。\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e?\u003c/strong\u003e 由于 Kubernetes API 版本之间的变化，部分功能无法正确地在 Dashboard 中工作。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e默认情况下，Dashboard 使用最小 RBAC 配置进行部署。目前，Dashboard 仅支持使用 Bearer Token 登录。可以按照\u003ca target=\"_blank\" target=\"_blank\" class=\"ext-link\" href=\"https://github.com/kubernetes/dashboard/wiki/Creating-sample-user\"\u003e关于创建示例用户的指南\u003c/a\u003e 进行操作。\u003c/p\u003e\n\u003cp\u003e关于 Dashboard 的使用，随后会抽时间再详细写一篇进行介绍。\u003c/p\u003e\n\u003ch2 id=\"hash-六、Inress-nginx\"\u003e六、Inress-nginx\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e选择一个节点，打上 \u003ccode\u003enode.k8s.xx.cn/role: ingress\u003c/code\u003e 标签，以便于下一步进行 Pod 调度。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e下载 ingress-nginx 资源信息\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token function\"\u003ewget\u003c/span\u003e https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml\n\u003cspan class=\"token function\"\u003ewget\u003c/span\u003e https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/baremetal/service-nodeport.yaml\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col\u003e\n\u003cli\u003e修改配置信息\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e修改 ingress-nginx 安装文件 \u003ccode\u003emandatory.yaml\u003c/code\u003e，以确保 nginx-ingress-controller 运行在指定节点上。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token punctuation\"\u003e...\u003c/span\u003e\n      \u003cspan class=\"token key atrule\"\u003enodeSelector\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token key atrule\"\u003ekubernetes.io/os\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e linux\n        \u003cspan class=\"token key atrule\"\u003enode.k8s.xx.cn/role\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ingress\n      \u003cspan class=\"token key atrule\"\u003eserviceAccountName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e nginx\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003eingress\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003eserviceaccount\n\u003cspan class=\"token punctuation\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e配置 service 为集群 IP 类型，并配置 \u003ccode\u003eexternalIPs\u003c/code\u003e 以对外暴露服务。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token key atrule\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e v1\n\u003cspan class=\"token key atrule\"\u003ekind\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Service\n\u003cspan class=\"token key atrule\"\u003emetadata\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ingress\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003enginx\n  \u003cspan class=\"token key atrule\"\u003enamespace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ingress\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003enginx\n  \u003cspan class=\"token key atrule\"\u003elabels\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token key atrule\"\u003eapp.kubernetes.io/name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ingress\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003enginx\n    \u003cspan class=\"token key atrule\"\u003eapp.kubernetes.io/part-of\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ingress\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003enginx\n\u003cspan class=\"token key atrule\"\u003espec\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003etype\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ClusterIP\n  \u003cspan class=\"token key atrule\"\u003eexternalIPs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e 10.163.10.7\n  \u003cspan class=\"token key atrule\"\u003eports\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e http\n      \u003cspan class=\"token key atrule\"\u003eport\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e80\u003c/span\u003e\n      \u003cspan class=\"token key atrule\"\u003etargetPort\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e80\u003c/span\u003e\n      \u003cspan class=\"token key atrule\"\u003eprotocol\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e TCP\n    \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e https\n      \u003cspan class=\"token key atrule\"\u003eport\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e443\u003c/span\u003e\n      \u003cspan class=\"token key atrule\"\u003etargetPort\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e443\u003c/span\u003e\n      \u003cspan class=\"token key atrule\"\u003eprotocol\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e TCP\n  \u003cspan class=\"token key atrule\"\u003eselector\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token key atrule\"\u003eapp.kubernetes.io/name\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ingress\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003enginx\n    \u003cspan class=\"token key atrule\"\u003eapp.kubernetes.io/part-of\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ingress\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003enginx\n\u003cspan class=\"token punctuation\"\u003e---\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col\u003e\n\u003cli\u003e安装 ingress-nginx\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ekubectl apply -f mandatory.yaml\nkubectl apply -f service-nodeport.yaml\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"hash-七、访问-Dashboard\"\u003e七、访问 Dashboard\u003c/h2\u003e\n\u003cp\u003e现在有了 Dashboard 和 Ingress 我们可以通过一些简单的配置使 dashbaord 可从外部访问。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1、创建 Service 以将外部流量倒向 Dashboard\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token key atrule\"\u003ekind\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Service\n\u003cspan class=\"token key atrule\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e v1\n\u003cspan class=\"token key atrule\"\u003emetadata\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e kubernetes\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edashboard\n  \u003cspan class=\"token key atrule\"\u003enamespace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e kubernetes\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edashboard\n  \u003cspan class=\"token key atrule\"\u003elabels\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token key atrule\"\u003ek8s-app\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e kubernetes\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edashboard\n\u003cspan class=\"token key atrule\"\u003espec\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003eports\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003eprotocol\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e TCP\n      \u003cspan class=\"token key atrule\"\u003eport\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e443\u003c/span\u003e\n      \u003cspan class=\"token key atrule\"\u003etargetPort\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e8443\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003eselector\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token key atrule\"\u003ek8s-app\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e kubernetes\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edashboard\n  \u003cspan class=\"token key atrule\"\u003etype\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ClusterIP\n  \u003cspan class=\"token key atrule\"\u003esessionAffinity\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e None\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e2、创建存储 TLS 数字证书的 Secret\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eDashboard 只能通过 HTTPS 访问，我们需要准备一个域名并为其签发数字证书。以 \u003ccode\u003ewww.yourdomain.com\u003c/code\u003e 域名为例，在命名空间 \u003ccode\u003ekubernetes-dashboard\u003c/code\u003e 创建 Secret。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ekubectl create secret tls cloud.jfjbapp.cn --cert\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token environment constant\"\u003e$HOME\u003c/span\u003e/certs/dashboard.crt --key\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token environment constant\"\u003e$HOME\u003c/span\u003e/certs/dashboard.key -n kubernetes-dashboard\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e3、创建 Ingerss 将外部流量倒入集群\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token key atrule\"\u003ekind\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Ingress\n\u003cspan class=\"token key atrule\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e extensions/v1beta1\n\u003cspan class=\"token key atrule\"\u003emetadata\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e dashboard\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003eingress\n  \u003cspan class=\"token key atrule\"\u003enamespace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e kubernetes\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edashboard\n  \u003cspan class=\"token key atrule\"\u003eannotations\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token key atrule\"\u003enginx.ingress.kubernetes.io/backend-protocol\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e HTTPS\n    \u003cspan class=\"token key atrule\"\u003enginx.ingress.kubernetes.io/rewrite-target\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e /$2\n    \u003cspan class=\"token key atrule\"\u003enginx.ingress.kubernetes.io/use-regex\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'true'\u003c/span\u003e\n\u003cspan class=\"token key atrule\"\u003espec\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003etls\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ehosts\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e www.yourdomain.com\n      \u003cspan class=\"token key atrule\"\u003esecretName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e www.yourdomain.com\n  \u003cspan class=\"token key atrule\"\u003erules\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003ehost\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e www.yourdomain.com\n      \u003cspan class=\"token key atrule\"\u003ehttp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token key atrule\"\u003epaths\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003epath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e /kube(/\u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e$)(.\u003cspan class=\"token important\"\u003e*)\u003c/span\u003e\n            \u003cspan class=\"token key atrule\"\u003ebackend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n              \u003cspan class=\"token key atrule\"\u003eserviceName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e kubernetes\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003edashboard\n              \u003cspan class=\"token key atrule\"\u003eservicePort\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e443\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e浏览器访问 \u003ca target=\"_blank\" target=\"_blank\" class=\"ext-link\" href=\"https://www.yourdomain.com/kube/%EF%BC%8C%E8%BE%93%E5%85%A5%E7%99%BB%E9%99%86%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%8D%B3%E5%8F%AF%E6%AD%A3%E5%B8%B8%E4%BD%BF%E7%94%A8\"\u003ehttps://www.yourdomain.com/kube/，输入登陆信息，即可正常使用\u003c/a\u003e Kubernetes Dashboard 。\u003c/p\u003e\n\u003ch2 id=\"hash-八、完成\"\u003e八、完成\u003c/h2\u003e\n\u003cp\u003e现在我们已经拥有一个 4 工作节点的单控制平面 k8s 集群，本文仅简单介绍了部署过程，关于集群的管理、使用还会涉及到非常多 k8s 概念及领域知识，官网文档基本上很详细的介绍了各类概念，还有详尽的操作演示，可以多看、多实践。\u003c/p\u003e\n","words":11590,"toc":[{"depth":2,"value":"一、拓扑结构","id":"hash-一、拓扑结构"},{"depth":2,"value":"二、准备工作","id":"hash-二、准备工作"},{"depth":2,"value":"三、部署控制平面节点","id":"hash-三、部署控制平面节点"},{"depth":2,"value":"四、加入工作节点","id":"hash-四、加入工作节点"},{"depth":2,"value":"五、安装 Dashboard","id":"hash-五、安装-Dashboard"},{"depth":2,"value":"六、Inress-nginx","id":"hash-六、Inress-nginx"},{"depth":2,"value":"七、访问 Dashboard","id":"hash-七、访问-Dashboard"},{"depth":2,"value":"八、完成","id":"hash-八、完成"}],"title":"使用 kubeadm 安装单控制平面 Kubernetes 集群","date":"2020-01-19T12:30:54.000Z","draft":false,"description":"本文主要介绍如何使用 kubeadm 安装部署单控制平面 Kubernetes v1.17.0 集群，所谓单控制平面，顾名思义就是由一个 Control-plane Node 和多个 Work Node 组成的 Kubernetes 集群。","type":"posts","tags":["kubernetes","docker","dashboard","ingress-nginx"],"series":false,"author":"Gl","cover":"cover.png"},"prev":{"title":"微服务 API 网关 KrakenD","date":1578727693000,"draft":false,"description":"KrakenD 是一个高性能无状态、分布式、微服务 API 网关，其不仅可以轻松将客户端请求转发到后端服务，还具备强大的数据处理功能，支持转换、聚合和修剪来自后端服务甚至第三方服务的返回数据，从而消除处理多个 REST 服务的必要性，使客户端与微服务的实现细节隔离开来。这一切通过简单的配置即可实现，本文介绍 KrakendD 如何安装部署并快速投入应用。","type":"posts","tags":["service-mesh","krakend","api-getway"],"series":false,"author":"Gl","cover":false,"path":"/blogs/2020/microservice-api-gateway-krakend","slug":"2020/microservice-api-gateway-krakend"},"next":{"title":"Ubuntu 18.04 安装 Java 环境 - OpenJDK","date":1579537208000,"draft":false,"description":"Java 和 JVM（Java 的虚拟机）被广泛使用，本文介绍如何使用 apt-get 安装不同版本的 Open JRE 和 Open JDK。JRE 仅用于提供 Java 应用程序执行环境，如果要编译 Java 应用程序，则要安装 JDK。","type":"posts","tags":["Java"],"series":false,"author":"Gl","cover":false,"path":"/blogs/2020/how-to-install-java-with-apt-get-on-ubuntu","slug":"2020/how-to-install-java-with-apt-get-on-ubuntu"}},"__N_SSG":true},"page":"/blogs/[...id]","query":{"id":["2020","creating-single-control-plane-cluster-with-kubeadm"]},"buildId":"QAI6xvOdSiTAPcw5Wz8zx","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>