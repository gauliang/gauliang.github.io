<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta content="viewport-fit=cover, width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/><title>Rancher 2.2.2 - HA 部署高可用k8s集群 - Gauliang</title><meta name="next-head-count" content="3"/><link href="https://unpkg.com/prismjs@0.0.1/themes/prism-okaidia.css" rel="stylesheet"/><link rel="icon" href="/favicon.svg"/><link rel="apple-touch-icon" href="/favicon.png"/><link rel="apple-touch-startup-image" href="/favicon.png"/><link rel="manifest" href="/manifest.json"/><meta name="apple-mobile-web-app-title" content="Blog"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><meta name="theme-color" content="#FFF"/><link rel="preload" href="/_next/static/css/5f73603ea6e352ce.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5f73603ea6e352ce.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-d7b038a63b619762.js" defer=""></script><script src="/_next/static/chunks/framework-a87821de553db91d.js" defer=""></script><script src="/_next/static/chunks/main-03586e2758997a42.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f1e48f2808f3843c.js" defer=""></script><script src="/_next/static/chunks/0c428ae2-cbec42c88474d6d7.js" defer=""></script><script src="/_next/static/chunks/167-1f992d16f0af3a0d.js" defer=""></script><script src="/_next/static/chunks/424-df8d47b174038bde.js" defer=""></script><script src="/_next/static/chunks/pages/blogs/%5B...id%5D-6a2f6ffd029f66d2.js" defer=""></script><script src="/_next/static/FMhAt0KIvn5yR6X5XTpe4/_buildManifest.js" defer=""></script><script src="/_next/static/FMhAt0KIvn5yR6X5XTpe4/_ssgManifest.js" defer=""></script><script src="/_next/static/FMhAt0KIvn5yR6X5XTpe4/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><nav class="md:sticky md:top-0 backdrop-blur md:bg-white/80 border-gray-200 md:border-b py-1 md:py-5 md:px-5 dark:bg-gray-800 dark:border-gray-700 z-10"><div class="md:container md:mx-auto flex flex-wrap flex-col md:flex-row justify-between"><div class="hidden md:flex px-5 md:px-0 flex-row justify-between text-[#0069ff] dark:text-white"><div class="flex flex-row cursor-pointer"><div class="w-6 h-6 my-2 md:w-8 md:h-8 md:my-1"><svg viewBox="0 0 512 512" fill="currentColor"><path d="M238.74,366.17c-24.56,0.42-12.59,0.42-36.76,0 C92.86,358.74,92.54,257.24,92.54,257.24s-3.78-104.91,109.44-110.42c105.79,0.4,195.22,0.23,242.54,0.08 c40.86-0.53,36.61-7.61,26.7-24.61C447.75,81.99,384.8,3.28,250.71,0C-60.02,17.45-88.35,433.93,194.97,504.76 c42.5,12.75,91.65,4.77,91.65,4.77s-0.23-52.54,0-94.13C286.82,378.65,274.71,365.55,238.74,366.17z M482.55,207.28 c-12,0.02-229.21,1.03-280.57,0.86c-48.75-0.16-48.73,49.23-48.73,49.23s0.19,47.49,48.73,47.5c-0.03,0,109.56-0.35,121.41,0 c11.91,0.35,24.03,12.59,23.94,25.04c-0.19,27.35,0.46,163.59,0.64,163.53c24.08-8.5,157.24-66.58,161.49-236.57 C510.08,231.99,506.75,207.3,482.55,207.28z"></path></svg></div><span class="text-xl h-8 ml-2 my-1.5 font-semibold">Gauliang</span></div><div class="md:hidden"><div class="relative"><button class=" flex h-10 flex-row items-center py-2 focus:outline-none text-blue-500 dark:text-blue-500 md:dark:text-white md:text-inherit" id="headlessui-popover-button-:R9d6:" type="button" aria-expanded="false"><span class="dark:hidden"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></svg> <!-- --></span><span class="hidden dark:inline"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.858 1.311A7.269 7.269 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.316 7.316 0 0 0 5.205-2.162c-.337.042-.68.063-1.029.063-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></svg></span></button></div></div></div><div class="hidden md:flex items-start md:items-center flex-col md:flex-row mt-2 md:mt-0 mb-5 md:mb-0"><ul class="flex flex-row justify-between ml-2 md:ml-0 space-x-0 md:space-x-6 "><li><a class="block py-2 mx-3 font-semibold md:border-none " href="/">首页</a></li><li><a class="block py-2 mx-3 font-semibold md:border-none text-blue-500 border-b-2 border-blue-500" href="/blogs/">博客</a></li><li><a class="block py-2 mx-3 font-semibold md:border-none " href="/tags/">标签</a></li><li><a class="block py-2 mx-3 font-semibold md:border-none " href="/series/">系列</a></li><li><a class="block py-2 mx-3 font-semibold md:border-none " href="/about/">关于</a></li></ul><ul class="flex-row space-x-6 border-l dark:border-slate-600 ml-6 pl-6 hidden md:flex"><li><div class="relative"><button class=" flex h-10 flex-row items-center py-2 focus:outline-none text-blue-500 dark:text-blue-500 md:dark:text-white md:text-inherit" id="headlessui-popover-button-:Rqd6:" type="button" aria-expanded="false"><span class="dark:hidden"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></svg> <!-- --></span><span class="hidden dark:inline"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.858 1.311A7.269 7.269 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.316 7.316 0 0 0 5.205-2.162c-.337.042-.68.063-1.029.063-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></svg></span></button></div></li><li><a href="https://github.com/gauliang" target="_blank" rel="noreferrer" class="block py-1 "><svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.463 2 11.97c0 4.404 2.865 8.14 6.839 9.458.5.092.682-.216.682-.48 0-.236-.008-.864-.013-1.695-2.782.602-3.369-1.337-3.369-1.337-.454-1.151-1.11-1.458-1.11-1.458-.908-.618.069-.606.069-.606 1.003.07 1.531 1.027 1.531 1.027.892 1.524 2.341 1.084 2.91.828.092-.643.35-1.083.636-1.332-2.22-.251-4.555-1.107-4.555-4.927 0-1.088.39-1.979 1.029-2.675-.103-.252-.446-1.266.098-2.638 0 0 .84-.268 2.75 1.022A9.606 9.606 0 0112 6.82c.85.004 1.705.114 2.504.336 1.909-1.29 2.747-1.022 2.747-1.022.546 1.372.202 2.386.1 2.638.64.696 1.028 1.587 1.028 2.675 0 3.83-2.339 4.673-4.566 4.92.359.307.678.915.678 1.846 0 1.332-.012 2.407-.012 2.734 0 .267.18.577.688.48C19.137 20.107 22 16.373 22 11.969 22 6.463 17.522 2 12 2z"></path></svg></a></li></ul></div><div class="flex pl-2 pr-5 justify-between items-center md:hidden"><a class="flex flex-row items-center justify-start space-x-2 text-blue-500 dark:text-blue-500 font-bold" href="/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"></path></svg><span>首页</span></a><div class="relative"><button class=" flex h-10 flex-row items-center py-2 focus:outline-none text-blue-500 dark:text-blue-500 md:dark:text-white md:text-inherit" id="headlessui-popover-button-:Rbd6:" type="button" aria-expanded="false"><span class="dark:hidden"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></svg> <!-- --></span><span class="hidden dark:inline"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.858 1.311A7.269 7.269 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.316 7.316 0 0 0 5.205-2.162c-.337.042-.68.063-1.029.063-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></svg></span></button></div></div></div></nav><main class="mx-auto container"><div class="mx-5 xl:mx-10 flex flex-row md:space-x-8"><div class="hidden md:block md:basis-1/6 shrink-0 py-20"><div class="sticky top-28"><div class="uppercase text-black dark:text-white font-bold">Contents</div><ul class="TableOfContents text-gray-400 mt-5 text-sm"><li class="mb-3"><a href="#hash-一、推荐架构" class="nav-link ">一、推荐架构</a></li><li class="mb-3"><a href="#hash-二、准备工作" class="nav-link ">二、准备工作</a></li><li class="mb-3"><a href="#hash-三、创建节点和负载均衡" class="nav-link ">三、创建节点和负载均衡</a></li><li class="mb-3"><a href="#hash-四、使用-RKE-安装-kubernetes" class="nav-link ">四、使用 RKE 安装 kubernetes</a></li><li class="mb-3"><a href="#hash-五、安装-Rancher" class="nav-link ">五、安装 Rancher</a></li><li class="mb-3"><a href="#hash-六、结语" class="nav-link ">六、结语</a></li></ul></div></div><div class="basis-3/3 w-full md:w-1 md:basis-5/6 xl:basis-4/6"><div class="md:mb-12 border-gray-200 py-8 md:py-20"><div class="flex space-x-2 items-center text-sm font-light text-gray-600 dark:text-gray-400"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"></path></svg><div>阅读全文约需 <!-- -->20<!-- --> 分钟<!-- --></div><div class="grow"></div></div><h1 class="text-2xl md:text-5xl md:leading-tight my-4 md:my-8 subpixel-antialiased font-semibold">Rancher 2.2.2 - HA 部署高可用k8s集群</h1><div class="text-sm text-gray-600 dark:text-gray-400 font-light flex items-center space-x-2"><time>2019-05-09 15:33:00</time><span>By</span><span>高国良</span></div></div><article class="post-content"><p>对于生产环境，需以高可用的配置安装 Rancher，确保用户始终可以访问 Rancher Server。当安装在 Kubernetes 集群中时，Rancher将与集群的 etcd 集成，并利用Kubernetes 调度实现高可用。</p>
<p>为确保高可用，本文所部署的 Kubernetes 集群将专用于运行 Rancher ，Rancher 运行起来后，可再创建或导入集群以运行具体的工作负载。</p>
<h2 id="hash-一、推荐架构">一、推荐架构</h2>
<ul>
<li>Rancher的DNS 应解析到 4层(TCP) 负载均衡上。</li>
<li>负载均衡应将端口 TCP/80 和 TCP/443 转发到 Kubernetes 集群中的所有3个节点。</li>
<li>Ingress-controller 将 HTTP 重定向到HTTPS并终止端口 TCP/443 上的 SSL/TLS（SSL数字证书在这里部署）。</li>
<li>Ingress-controller 将流量转发到 pod 的 TCP/80 端口。</li>
</ul>
<p>下面是一张从官网拉过来的图片,更直观一些。</p>
<div class="image-widget"><img src="/attachments/posts/2019/rancher-2.2.2-ha-cluster.files/https://rancher.com/docs/img/rancher/ha/rancher2ha.svg" alt="image"><div class="figcaption">image</div></div>
<h2 id="hash-二、准备工作">二、准备工作</h2>
<h3 id="hash-1-服务器准备">1. 服务器准备</h3>
<ol>
<li>1台 Linux服务器，配置不用很高，用于四层负载均衡</li>
<li>3台 Linux服务器，Rancker-server-node 节点</li>
<li>n台 Linux服务器，Rancker-agent-node 节点(n&#x3C;=50)</li>
</ol>
<p>节点服务器的硬件配置，可根据实际情况依据该表自行选择。</p>
<div class="table-responsive"><table>
<thead>
<tr>
<th>规模</th>
<th>集群</th>
<th>节点</th>
<th>CPU</th>
<th>内存</th>
</tr>
</thead>
<tbody>
<tr>
<td>小</td>
<td>最多5个</td>
<td>高达50</td>
<td>2</td>
<td>8 GB</td>
</tr>
<tr>
<td>中</td>
<td>最多15个</td>
<td>最多200</td>
<td>4</td>
<td>16 GB</td>
</tr>
<tr>
<td>大</td>
<td>高达50</td>
<td>最多500个</td>
<td>8</td>
<td>32 GB</td>
</tr>
<tr>
<td>超大</td>
<td>最多100个</td>
<td>高达1000</td>
<td>32</td>
<td>128 GB</td>
</tr>
<tr>
<td>更大规模</td>
<td>100+</td>
<td>1000+</td>
<td>联系 Rancher</td>
<td>联系 Rancher</td>
</tr>
</tbody>
</table></div>
<h3 id="hash-2-工具安装">2.工具安装</h3>
<p>这些工具软件将在部署过程中用到，需提前安装好，并确保通过 $PATH 变量可以找到。</p>
<p><strong>安装 kubectl</strong></p>
<p>这是一个 kubernetes 命令行工具，<a target="_blank" target="_blank" class="ext-link" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl">安装参考</a> K8S 官网</p>
<p>这里要注意的是，官网的安装过程是到谷歌云平台下载，这里我门修改下载链接为 RANCHER 提供的镜像地址。</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 下载目前最新版</span>
<span class="token function">wget</span> https://www.cnrancher.com/download/kubernetes/linux-amd64-v1.14.1-kubectl
<span class="token comment"># 设置执行权限</span>
<span class="token function">chmod</span> +x ./linux-amd64-v1.14.1-kubectl 
<span class="token comment"># 将其移动到 /usr/locak/bin/kubectl </span>
<span class="token function">sudo</span> <span class="token function">mv</span> ./linux-amd64-v1.14.1-kubectl /usr/local/bin/kubectl
</code></pre></div>
<p><strong>安装 RKE</strong></p>
<p>RKE 全称 Rancher Kubernetes Engine，是一个用于构建 kubernets 集群的命令行工具。网络原因，我们切换到 Rancher 提供的镜像地址下载安装</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 下载目前最新版</span>
<span class="token function">wget</span> https://www.cnrancher.com/download/rke/v0.1.18-rke_linux-amd64
<span class="token comment"># 设置执行权限</span>
<span class="token function">chmod</span> +x v0.1.18-rke_linux-amd64
<span class="token comment"># 将其移动到 /usr/locak/bin/kubectl </span>
<span class="token function">sudo</span> <span class="token function">cp</span> v0.1.18-rke_linux-amd64 /usr/local/bin/rke
<span class="token comment"># 验证安装</span>
rke --version <span class="token comment"># rke version v0.1.18</span>
</code></pre></div>
<p><strong>安装 helm</strong></p>
<p>helm 是Kubernetes的包管理器。Helm版本需高于 <code>v2.12.1</code>。</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 网络原因，切换到 Rancher 提供的镜像连接</span>
<span class="token function">wget</span> https://www.cnrancher.com/download/helm/helm-v2.13.1-linux-amd64.tar.gz
<span class="token comment"># 解压</span>
<span class="token function">tar</span> -zxvf helm-v2.0.0-linux-amd64.tgz
<span class="token comment"># 移动到 /usr/local/bin/helm</span>
<span class="token function">mv</span> linux-amd64/helm /usr/local/bin/helm
</code></pre></div>
<h2 id="hash-三、创建节点和负载均衡">三、创建节点和负载均衡</h2>
<p>这些节点须在同一个网络区域或数据中心。</p>
<h3 id="hash-1-节点准备">1. 节点准备</h3>
<p><strong>操作系统</strong></p>
<p>所有节点安装 ubuntu 18.04(64-bit x86)</p>
<p><strong>网络要求</strong>
注意参考 <a target="_blank" target="_blank" class="ext-link" href="https://rancher.com/docs/rancher/v2.x/en/installation/requirements/#">官网</a>放行相关端口。本文 ip 清单（仅用于演示）：</p>
<div class="table-responsive"><table>
<thead>
<tr>
<th>NODE</th>
<th>IP</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>NODE-LB</td>
<td>公网 168.168.168.1 / 内网 10.0.0.1</td>
<td>四层负载均衡</td>
</tr>
<tr>
<td>NODE-SERVER</td>
<td>公网 168.168.168.6 / 内网 10.0.0.6</td>
<td>local 集群</td>
</tr>
<tr>
<td>NODE-SERVER</td>
<td>公网 168.168.168.7 / 内网 10.0.0.7</td>
<td>local 集群</td>
</tr>
<tr>
<td>NODE-SERVER</td>
<td>公网 168.168.168.8 / 内网 10.0.0.8</td>
<td>local 集群</td>
</tr>
<tr>
<td>NODE-WORKER</td>
<td>公网 168.168.168.16 / 内网 10.0.0.16</td>
<td>工作负载</td>
</tr>
<tr>
<td>NODE-WORKER</td>
<td>公网 168.168.168.17 / 内网 10.0.0.17</td>
<td>工作负载</td>
</tr>
<tr>
<td>NODE-WORKER</td>
<td>公网 168.168.168.18 / 内网 10.0.0.18</td>
<td>工作负载</td>
</tr>
</tbody>
</table></div>
<p><strong>docker-ce</strong></p>
<p>并安装最新stable版 docker-ce:18.09.6</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 删除旧版本docker</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> remove <span class="token function">docker</span> docker-engine docker.io containerd runc

<span class="token comment"># 更新 apt </span>
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update

<span class="token comment"># 安装工具包</span>
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token punctuation">\</span>
    apt-transport-https <span class="token punctuation">\</span>
    ca-certificates <span class="token punctuation">\</span>
    <span class="token function">curl</span> <span class="token punctuation">\</span>
    gnupg-agent <span class="token punctuation">\</span>
    software-properties-common

<span class="token comment"># 添加Docker官方 GPG key</span>
$ <span class="token function">curl</span> -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -

<span class="token comment"># 添加 stable apt 源</span>
$ <span class="token function">sudo</span> add-apt-repository <span class="token punctuation">\</span>
   <span class="token string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> \
   stable"</span>

<span class="token comment"># 安装 Docker CE</span>
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update
$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> docker-ce docker-ce-cli containerd.io

<span class="token comment"># 将当前用户加入"docker"用户组，加入到该用户组的账号在随后安装过程会用到。用于节点访问的SSH用户必须是节点上docker组的成员：</span>
$ <span class="token function">sudo</span> <span class="token function">usermod</span> -aG <span class="token function">docker</span> <span class="token environment constant">$USER</span>
</code></pre></div>
<h3 id="hash-2-配置四层负载均衡">2. 配置四层负载均衡</h3>
<p>RKE 将会在每个节点上配置一个 Ingress-controller pod，这个 pod 将绑定到该节点的 TCP/80 和 TCP/443 端口，作为 Rancher-server 的HTTPS流量入口点。</p>
<p>将负载均衡器配置为基本的第4层TCP转发器，这里采用 NGINX 作四层负载均衡。</p>
<p>*<strong>安装 Nginx</strong></p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> nginx
<span class="token comment"># /usr/sbin/nginx：主程序</span>
<span class="token comment"># /etc/nginx：存放配置文件</span>
<span class="token comment"># /usr/share/nginx：存放静态文件</span>
<span class="token comment"># /var/log/nginx：存放日志</span>
</code></pre></div>
<p>更新配置文件 <code>/etc/nginx/nginx.conf</code></p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">worker_processes 4;
worker_rlimit_nofile 40000;

events {
    worker_connections 8192;
}

stream {
    upstream rancher_servers_http {
        least_conn;
        server 10.0.0.6:80 max_fails=3 fail_timeout=5s;
        server 10.0.0.7:80 max_fails=3 fail_timeout=5s;
        server 10.0.0.8:80 max_fails=3 fail_timeout=5s;
    }
    server {
        listen     80;
        proxy_pass rancher_servers_http;
    }

    upstream rancher_servers_https {
        least_conn;
        server 10.0.0.6:443 max_fails=3 fail_timeout=5s;
        server 10.0.0.7:443 max_fails=3 fail_timeout=5s;
        server 10.0.0.8:443 max_fails=3 fail_timeout=5s;
    }
    
    server {
        listen     443;
        proxy_pass rancher_servers_https;
    }
}</code></pre></div>
<blockquote>
</blockquote>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">注意：将local群集专用于Rancher。</code></pre></div>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">勿将此负载均衡（即local群集Ingress）对 Rancher 以外的应用程序进行负载转发。</code></pre></div>
<h2 id="hash-四、使用-RKE-安装-kubernetes">四、使用 RKE 安装 kubernetes</h2>
<p>下面使用 RKE(Kubernetes Engine) 安装高可用的 Kubernetes。</p>
<h3 id="hash-1-NODE-SERVER-之间建立-ssh-信任">1. NODE-SERVER 之间建立 ssh 信任</h3>
<p>我们目前有三台服务器用作 local 集群，首先要确保我们主机能够通过 ssh 访问到另外两台主机并执行相关操作。比如执行 docker 命令，还记得前面我们加入 docker 用户组的用户吧。</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 根据需求配置相关信息生成 rsa 公钥密钥</span>
ssh-keygen

<span class="token comment"># 复制当前主机上的公钥到另外两台上面，实现免密码登录</span>
ssh-copy-id -i ~/.ssh/id_rsa.pub user@x.x.x.x

<span class="token comment"># 要注意这里也要跟自己注册注册一下 ：ssh-copy-id -i ~/.ssh/id_rsa.pub user@本机ip</span>
</code></pre></div>
<h3 id="hash-2-编写-rancher-cluster-yml-文件">2. 编写 rancher-cluster.yml 文件</h3>
<p>这里需要注意，这个文件没有明确配置rsa文件名，默认会使用 <code>$HOME/.ssh/id_rsa</code> 建立连接。内容如下</p>
<div class="remark-highlight"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">nodes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">address</span><span class="token punctuation">:</span> 168.168.168.6
    <span class="token key atrule">internal_address</span><span class="token punctuation">:</span> 10.0.0.6
    <span class="token key atrule">user</span><span class="token punctuation">:</span> ubuntu
    <span class="token key atrule">role</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>controlplane<span class="token punctuation">,</span>worker<span class="token punctuation">,</span>etcd<span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">address</span><span class="token punctuation">:</span> 168.168.168.7
    <span class="token key atrule">internal_address</span><span class="token punctuation">:</span> 10.0.0.7
    <span class="token key atrule">user</span><span class="token punctuation">:</span> ubuntu
    <span class="token key atrule">role</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>controlplane<span class="token punctuation">,</span>worker<span class="token punctuation">,</span>etcd<span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">address</span><span class="token punctuation">:</span> 168.168.168.8
    <span class="token key atrule">internal_address</span><span class="token punctuation">:</span> 10.0.0.8
    <span class="token key atrule">user</span><span class="token punctuation">:</span> ubuntu
    <span class="token key atrule">role</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>controlplane<span class="token punctuation">,</span>worker<span class="token punctuation">,</span>etcd<span class="token punctuation">]</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">etcd</span><span class="token punctuation">:</span>
    <span class="token key atrule">snapshot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">creation</span><span class="token punctuation">:</span> 6h
    <span class="token key atrule">retention</span><span class="token punctuation">:</span> 24h
</code></pre></div>
<h3 id="hash-3-运行-RKE-构建-kubernetes-集群">3. 运行 RKE 构建 kubernetes 集群</h3>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">rke up --config ./rancher-cluster.yml
<span class="token comment"># 验证：返回类似下面的消息则说明执行成功，有问题欢迎留言交流。</span>
<span class="token comment"># Finished building Kubernetes cluster successfully.</span>
</code></pre></div>
<p>执行成功会在当前目录生成一个文件 <code>kube_config_rancher-cluster.yml</code>，将该文件复制到 <code>.kube/kube_config_rancher-cluster.yml</code>。</p>
<p>或者</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>/kube_config_rancher-cluster.yml
</code></pre></div>
<h3 id="hash-4-测试集群">4. 测试集群</h3>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">kubectl get nodes
<span class="token comment"># 返回下面信息说明集群创建成功</span>
NAME           STATUS   ROLES                      AGE   VERSION
<span class="token number">168.168</span>.168.6   Ready    controlplane,etcd,worker   13m   v1.13.5
<span class="token number">168.168</span>.168.7   Ready    controlplane,etcd,worker   13m   v1.13.5
<span class="token number">168.168</span>.168.8   Ready    controlplane,etcd,worker   13m   v1.13.5
</code></pre></div>
<h3 id="hash-5-保存好相关配置文件">5. 保存好相关配置文件</h3>
<p>当排除故障、升级群集时需要用到以下文件，请将其副本保存在一个安全的位置。</p>
<p><code>rancher-cluster.yml</code>：RKE集群配置文件。
<code>kube_config_rancher-cluster.yml</code>：群集的Kubeconfig文件，此文件包含完全访问群集的凭据。
<code>rancher-cluster.rkestate</code>：Kubernetes群集状态文件，此文件包含完全访问群集的凭据。</p>
<h3 id="hash-6-初始化-Helm">6. 初始化 Helm</h3>
<p>一开始，我们安装了 Helm ，Helm 是 Kubernetes 首选的包管理工具。为了能够使用 Helm，需要在群集上安装服务器端组件 tiller。</p>
<p>Kubernetes APIServer 开启了 RBAC 访问控制，所以需要创建 tiller 使用的service account: tiller 并分配合适的角色给它。</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 在 kube-system 命名空间下创建一个 serviceaccount ,并将角色绑定给 tiller</span>
kubectl -n kube-system create serviceaccount tiller

<span class="token comment"># 然后， heml 就可以在集群上安装 tiller 了</span>
<span class="token comment"># 同样，网络原因，我们需要配置一个镜像仓库地址</span>
helm init --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.13.1 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts

<span class="token comment"># 输出：$HELM_HOME has been configured at /home/ubuntu/.helm.</span>
</code></pre></div>
<h3 id="hash-7-测试-tiller-安装是否成功">7. 测试 tiller 安装是否成功</h3>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">kubectl -n kube-system  rollout status deploy/tiller-deploy
<span class="token comment"># 输出 deployment "tiller-deploy" successfully rolled out</span>

helm version
<span class="token comment"># Client: &#x26;version.Version{SemVer:"v2.13.1", GitCommit:"618447cbf203d147601b4b9bd7f8c37a5d39fbb4", GitTreeState:"clean"}</span>
<span class="token comment"># Server: &#x26;version.Version{SemVer:"v2.13.1", GitCommit:"618447cbf203d147601b4b9bd7f8c37a5d39fbb4", GitTreeState:"clean"}</span>
</code></pre></div>
<h2 id="hash-五、安装-Rancher">五、安装 Rancher</h2>
<p>这里注意选择 stable 版本，首先添加 heml 源仓库。</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">helm repo <span class="token function">add</span> rancher-stable https://releases.rancher.com/server-charts/stable
</code></pre></div>
<h3 id="hash-1-部署-Rancher-并配置-SSL-数字证书">1. 部署 Rancher 并配置 SSL 数字证书</h3>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">helm <span class="token function">install</span> rancher-stable/rancher <span class="token punctuation">\</span>
  --name rancher <span class="token punctuation">\</span>
  --namespace cattle-system <span class="token punctuation">\</span>
  --set <span class="token assign-left variable">hostname</span><span class="token operator">=</span>cloud.jfjbapp.cn <span class="token punctuation">\</span>
  --set ingress.tls.source<span class="token operator">=</span>secret

</code></pre></div>
<h3 id="hash-2-将通过-CA-机构签发的数字证书准备好，">2. 将通过 CA 机构签发的数字证书准备好，</h3>
<h3 id="hash-3-检查-rancher-是否成功可用">3. 检查 rancher 是否成功可用</h3>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">kubectl -n cattle-system rollout status deploy/rancher
Waiting <span class="token keyword">for</span> deployment <span class="token string">"rancher"</span> rollout to finish: <span class="token number">0</span> of <span class="token number">3</span> updated replicas are available<span class="token punctuation">..</span>.
deployment <span class="token string">"rancher"</span> successfully rolled out
</code></pre></div>
<h3 id="hash-4-访问-Rancher-UI">4. 访问 Rancher UI</h3>
<p>浏览器打开 <code>https://your.doamin</code>，为 <code>admin</code>账户设置初始密码，并登入系统。提示设置<code>server-url</code>，确保你的地址无误，确认即可。随后稍等皮片刻，待系统完成初始化。</p>
<p>如果出现local集群一直停留在等待状态，并提示 <code>Waiting for server-url setting to be set</code>，可以尝试点击 全局->local->升级->添加一个成员角色（admin/ClusterOwner）->保存即可。</p>
<h2 id="hash-六、结语">六、结语</h2>
<p>至此，已完成 Rancher 2.2.2 的 HA 安装，后续再做一些安全加固，检查各项配置确保无安全风险，即可开始提供服务。随后会抽空再写一篇文章简单介绍微服务架构应用的部署。</p>
</article><div class="flex flex-wrap items-center md:space-x-2 my-24 pt-8 border-t border-solid border-gray-100 dark:border-gray-600"><div class="font-bold text-black text-base dark:text-white "><strong>标签：</strong></div><div class="text-blue-600 flex text-sm flex-wrap dark:text-slate-400"><a class="mr-4 hover:underline" href="/tags/rancher/">RANCHER</a><a class="mr-4 hover:underline" href="/tags/kubernetes/">KUBERNETES</a><a class="mr-4 hover:underline" href="/tags/docker/">DOCKER</a></div></div><div class="next-and-prev-post"><a class="prev-post" href="/blogs/2019/vlc-fm-playlist/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"></path></svg><div class="text"><div class="caption">2019-05-02 04:16:00</div><div class="title">VLC-FM PLAYLIST</div></div></a><a class="next-post" href="/blogs/2019/install-gradle-on-fedora30/"><div class="text"><div class="caption">2019-05-12 23:07:00</div><div class="title">Fedora 30 安装 Gradle</div></div><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"></path></svg></a></div></div><div class="hidden xl:block xl:basis-1/6 shrink-0 relative "></div></div><button class="z-50 hidden md:flex scroll-to-top rounded-full whitespace-nowrap space-x-2 flex-row text-xs items-center uppercase py-2 px-5 text-white bg-blue-600 hover:bg-gray-800 transition"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 10a.5.5 0 0 0 .5-.5V3.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 3.707V9.5a.5.5 0 0 0 .5.5zm-7 2.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5z"></path></svg><span>Scroll to top</span></button></main><footer class="border-t dark:border-gray-700"><div class="container mx-auto pt-12 pb-20 opacity-50 hover:opacity-100 transition duration-500"><div class="flex flex-row justify-center items-center space-x-5"><a class="flex justify-center text-blue-500 w-8 h-8" href="/"><svg viewBox="0 0 512 512" fill="currentColor"><path d="M238.74,366.17c-24.56,0.42-12.59,0.42-36.76,0 C92.86,358.74,92.54,257.24,92.54,257.24s-3.78-104.91,109.44-110.42c105.79,0.4,195.22,0.23,242.54,0.08 c40.86-0.53,36.61-7.61,26.7-24.61C447.75,81.99,384.8,3.28,250.71,0C-60.02,17.45-88.35,433.93,194.97,504.76 c42.5,12.75,91.65,4.77,91.65,4.77s-0.23-52.54,0-94.13C286.82,378.65,274.71,365.55,238.74,366.17z M482.55,207.28 c-12,0.02-229.21,1.03-280.57,0.86c-48.75-0.16-48.73,49.23-48.73,49.23s0.19,47.49,48.73,47.5c-0.03,0,109.56-0.35,121.41,0 c11.91,0.35,24.03,12.59,23.94,25.04c-0.19,27.35,0.46,163.59,0.64,163.53c24.08-8.5,157.24-66.58,161.49-236.57 C510.08,231.99,506.75,207.3,482.55,207.28z"></path></svg></a><code class=" text-xs font-mono text-gray-500">$ echo &quot;simple things scale.&quot; </code></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":["posts","2019","rancher-2.2.2-ha-cluster"],"post":{"id":["posts","2019","rancher-2.2.2-ha-cluster"],"contentHtml":"\u003cp\u003e对于生产环境，需以高可用的配置安装 Rancher，确保用户始终可以访问 Rancher Server。当安装在 Kubernetes 集群中时，Rancher将与集群的 etcd 集成，并利用Kubernetes 调度实现高可用。\u003c/p\u003e\n\u003cp\u003e为确保高可用，本文所部署的 Kubernetes 集群将专用于运行 Rancher ，Rancher 运行起来后，可再创建或导入集群以运行具体的工作负载。\u003c/p\u003e\n\u003ch2 id=\"hash-一、推荐架构\"\u003e一、推荐架构\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eRancher的DNS 应解析到 4层(TCP) 负载均衡上。\u003c/li\u003e\n\u003cli\u003e负载均衡应将端口 TCP/80 和 TCP/443 转发到 Kubernetes 集群中的所有3个节点。\u003c/li\u003e\n\u003cli\u003eIngress-controller 将 HTTP 重定向到HTTPS并终止端口 TCP/443 上的 SSL/TLS（SSL数字证书在这里部署）。\u003c/li\u003e\n\u003cli\u003eIngress-controller 将流量转发到 pod 的 TCP/80 端口。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e下面是一张从官网拉过来的图片,更直观一些。\u003c/p\u003e\n\u003cdiv class=\"image-widget\"\u003e\u003cimg src=\"/attachments/posts/2019/rancher-2.2.2-ha-cluster.files/https://rancher.com/docs/img/rancher/ha/rancher2ha.svg\" alt=\"image\"\u003e\u003cdiv class=\"figcaption\"\u003eimage\u003c/div\u003e\u003c/div\u003e\n\u003ch2 id=\"hash-二、准备工作\"\u003e二、准备工作\u003c/h2\u003e\n\u003ch3 id=\"hash-1-服务器准备\"\u003e1. 服务器准备\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e1台 Linux服务器，配置不用很高，用于四层负载均衡\u003c/li\u003e\n\u003cli\u003e3台 Linux服务器，Rancker-server-node 节点\u003c/li\u003e\n\u003cli\u003en台 Linux服务器，Rancker-agent-node 节点(n\u0026#x3C;=50)\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e节点服务器的硬件配置，可根据实际情况依据该表自行选择。\u003c/p\u003e\n\u003cdiv class=\"table-responsive\"\u003e\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e规模\u003c/th\u003e\n\u003cth\u003e集群\u003c/th\u003e\n\u003cth\u003e节点\u003c/th\u003e\n\u003cth\u003eCPU\u003c/th\u003e\n\u003cth\u003e内存\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e小\u003c/td\u003e\n\u003ctd\u003e最多5个\u003c/td\u003e\n\u003ctd\u003e高达50\u003c/td\u003e\n\u003ctd\u003e2\u003c/td\u003e\n\u003ctd\u003e8 GB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e中\u003c/td\u003e\n\u003ctd\u003e最多15个\u003c/td\u003e\n\u003ctd\u003e最多200\u003c/td\u003e\n\u003ctd\u003e4\u003c/td\u003e\n\u003ctd\u003e16 GB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e大\u003c/td\u003e\n\u003ctd\u003e高达50\u003c/td\u003e\n\u003ctd\u003e最多500个\u003c/td\u003e\n\u003ctd\u003e8\u003c/td\u003e\n\u003ctd\u003e32 GB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e超大\u003c/td\u003e\n\u003ctd\u003e最多100个\u003c/td\u003e\n\u003ctd\u003e高达1000\u003c/td\u003e\n\u003ctd\u003e32\u003c/td\u003e\n\u003ctd\u003e128 GB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e更大规模\u003c/td\u003e\n\u003ctd\u003e100+\u003c/td\u003e\n\u003ctd\u003e1000+\u003c/td\u003e\n\u003ctd\u003e联系 Rancher\u003c/td\u003e\n\u003ctd\u003e联系 Rancher\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-2-工具安装\"\u003e2.工具安装\u003c/h3\u003e\n\u003cp\u003e这些工具软件将在部署过程中用到，需提前安装好，并确保通过 $PATH 变量可以找到。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e安装 kubectl\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e这是一个 kubernetes 命令行工具，\u003ca target=\"_blank\" target=\"_blank\" class=\"ext-link\" href=\"https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl\"\u003e安装参考\u003c/a\u003e K8S 官网\u003c/p\u003e\n\u003cp\u003e这里要注意的是，官网的安装过程是到谷歌云平台下载，这里我门修改下载链接为 RANCHER 提供的镜像地址。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# 下载目前最新版\u003c/span\u003e\n\u003cspan class=\"token function\"\u003ewget\u003c/span\u003e https://www.cnrancher.com/download/kubernetes/linux-amd64-v1.14.1-kubectl\n\u003cspan class=\"token comment\"\u003e# 设置执行权限\u003c/span\u003e\n\u003cspan class=\"token function\"\u003echmod\u003c/span\u003e +x ./linux-amd64-v1.14.1-kubectl \n\u003cspan class=\"token comment\"\u003e# 将其移动到 /usr/locak/bin/kubectl \u003c/span\u003e\n\u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003emv\u003c/span\u003e ./linux-amd64-v1.14.1-kubectl /usr/local/bin/kubectl\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e安装 RKE\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eRKE 全称 Rancher Kubernetes Engine，是一个用于构建 kubernets 集群的命令行工具。网络原因，我们切换到 Rancher 提供的镜像地址下载安装\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# 下载目前最新版\u003c/span\u003e\n\u003cspan class=\"token function\"\u003ewget\u003c/span\u003e https://www.cnrancher.com/download/rke/v0.1.18-rke_linux-amd64\n\u003cspan class=\"token comment\"\u003e# 设置执行权限\u003c/span\u003e\n\u003cspan class=\"token function\"\u003echmod\u003c/span\u003e +x v0.1.18-rke_linux-amd64\n\u003cspan class=\"token comment\"\u003e# 将其移动到 /usr/locak/bin/kubectl \u003c/span\u003e\n\u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003ecp\u003c/span\u003e v0.1.18-rke_linux-amd64 /usr/local/bin/rke\n\u003cspan class=\"token comment\"\u003e# 验证安装\u003c/span\u003e\nrke --version \u003cspan class=\"token comment\"\u003e# rke version v0.1.18\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003e安装 helm\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003ehelm 是Kubernetes的包管理器。Helm版本需高于 \u003ccode\u003ev2.12.1\u003c/code\u003e。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# 网络原因，切换到 Rancher 提供的镜像连接\u003c/span\u003e\n\u003cspan class=\"token function\"\u003ewget\u003c/span\u003e https://www.cnrancher.com/download/helm/helm-v2.13.1-linux-amd64.tar.gz\n\u003cspan class=\"token comment\"\u003e# 解压\u003c/span\u003e\n\u003cspan class=\"token function\"\u003etar\u003c/span\u003e -zxvf helm-v2.0.0-linux-amd64.tgz\n\u003cspan class=\"token comment\"\u003e# 移动到 /usr/local/bin/helm\u003c/span\u003e\n\u003cspan class=\"token function\"\u003emv\u003c/span\u003e linux-amd64/helm /usr/local/bin/helm\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"hash-三、创建节点和负载均衡\"\u003e三、创建节点和负载均衡\u003c/h2\u003e\n\u003cp\u003e这些节点须在同一个网络区域或数据中心。\u003c/p\u003e\n\u003ch3 id=\"hash-1-节点准备\"\u003e1. 节点准备\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e操作系统\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e所有节点安装 ubuntu 18.04(64-bit x86)\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e网络要求\u003c/strong\u003e\r\n注意参考 \u003ca target=\"_blank\" target=\"_blank\" class=\"ext-link\" href=\"https://rancher.com/docs/rancher/v2.x/en/installation/requirements/#\"\u003e官网\u003c/a\u003e放行相关端口。本文 ip 清单（仅用于演示）：\u003c/p\u003e\n\u003cdiv class=\"table-responsive\"\u003e\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eNODE\u003c/th\u003e\n\u003cth\u003eIP\u003c/th\u003e\n\u003cth\u003e备注\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eNODE-LB\u003c/td\u003e\n\u003ctd\u003e公网 168.168.168.1 / 内网 10.0.0.1\u003c/td\u003e\n\u003ctd\u003e四层负载均衡\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eNODE-SERVER\u003c/td\u003e\n\u003ctd\u003e公网 168.168.168.6 / 内网 10.0.0.6\u003c/td\u003e\n\u003ctd\u003elocal 集群\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eNODE-SERVER\u003c/td\u003e\n\u003ctd\u003e公网 168.168.168.7 / 内网 10.0.0.7\u003c/td\u003e\n\u003ctd\u003elocal 集群\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eNODE-SERVER\u003c/td\u003e\n\u003ctd\u003e公网 168.168.168.8 / 内网 10.0.0.8\u003c/td\u003e\n\u003ctd\u003elocal 集群\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eNODE-WORKER\u003c/td\u003e\n\u003ctd\u003e公网 168.168.168.16 / 内网 10.0.0.16\u003c/td\u003e\n\u003ctd\u003e工作负载\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eNODE-WORKER\u003c/td\u003e\n\u003ctd\u003e公网 168.168.168.17 / 内网 10.0.0.17\u003c/td\u003e\n\u003ctd\u003e工作负载\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eNODE-WORKER\u003c/td\u003e\n\u003ctd\u003e公网 168.168.168.18 / 内网 10.0.0.18\u003c/td\u003e\n\u003ctd\u003e工作负载\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003edocker-ce\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e并安装最新stable版 docker-ce:18.09.6\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# 删除旧版本docker\u003c/span\u003e\n\u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e remove \u003cspan class=\"token function\"\u003edocker\u003c/span\u003e docker-engine docker.io containerd runc\n\n\u003cspan class=\"token comment\"\u003e# 更新 apt \u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e update\n\n\u003cspan class=\"token comment\"\u003e# 安装工具包\u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    apt-transport-https \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    ca-certificates \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003ecurl\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    gnupg-agent \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n    software-properties-common\n\n\u003cspan class=\"token comment\"\u003e# 添加Docker官方 GPG key\u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003ecurl\u003c/span\u003e -fsSL https://download.docker.com/linux/ubuntu/gpg \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e apt-key \u003cspan class=\"token function\"\u003eadd\u003c/span\u003e -\n\n\u003cspan class=\"token comment\"\u003e# 添加 stable apt 源\u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e add-apt-repository \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n   \u003cspan class=\"token string\"\u003e\"deb [arch=amd64] https://download.docker.com/linux/ubuntu \\\n   \u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003elsb_release -cs\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e \\\n   stable\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# 安装 Docker CE\u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e update\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e docker-ce docker-ce-cli containerd.io\n\n\u003cspan class=\"token comment\"\u003e# 将当前用户加入\"docker\"用户组，加入到该用户组的账号在随后安装过程会用到。用于节点访问的SSH用户必须是节点上docker组的成员：\u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eusermod\u003c/span\u003e -aG \u003cspan class=\"token function\"\u003edocker\u003c/span\u003e \u003cspan class=\"token environment constant\"\u003e$USER\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-2-配置四层负载均衡\"\u003e2. 配置四层负载均衡\u003c/h3\u003e\n\u003cp\u003eRKE 将会在每个节点上配置一个 Ingress-controller pod，这个 pod 将绑定到该节点的 TCP/80 和 TCP/443 端口，作为 Rancher-server 的HTTPS流量入口点。\u003c/p\u003e\n\u003cp\u003e将负载均衡器配置为基本的第4层TCP转发器，这里采用 NGINX 作四层负载均衡。\u003c/p\u003e\n\u003cp\u003e*\u003cstrong\u003e安装 Nginx\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token function\"\u003esudo\u003c/span\u003e \u003cspan class=\"token function\"\u003eapt-get\u003c/span\u003e \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e nginx\n\u003cspan class=\"token comment\"\u003e# /usr/sbin/nginx：主程序\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# /etc/nginx：存放配置文件\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# /usr/share/nginx：存放静态文件\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# /var/log/nginx：存放日志\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e更新配置文件 \u003ccode\u003e/etc/nginx/nginx.conf\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eworker_processes 4;\r\nworker_rlimit_nofile 40000;\r\n\r\nevents {\r\n    worker_connections 8192;\r\n}\r\n\r\nstream {\r\n    upstream rancher_servers_http {\r\n        least_conn;\r\n        server 10.0.0.6:80 max_fails=3 fail_timeout=5s;\r\n        server 10.0.0.7:80 max_fails=3 fail_timeout=5s;\r\n        server 10.0.0.8:80 max_fails=3 fail_timeout=5s;\r\n    }\r\n    server {\r\n        listen     80;\r\n        proxy_pass rancher_servers_http;\r\n    }\r\n\r\n    upstream rancher_servers_https {\r\n        least_conn;\r\n        server 10.0.0.6:443 max_fails=3 fail_timeout=5s;\r\n        server 10.0.0.7:443 max_fails=3 fail_timeout=5s;\r\n        server 10.0.0.8:443 max_fails=3 fail_timeout=5s;\r\n    }\r\n    \r\n    server {\r\n        listen     443;\r\n        proxy_pass rancher_servers_https;\r\n    }\r\n}\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cblockquote\u003e\n\u003c/blockquote\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e注意：将local群集专用于Rancher。\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e勿将此负载均衡（即local群集Ingress）对 Rancher 以外的应用程序进行负载转发。\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"hash-四、使用-RKE-安装-kubernetes\"\u003e四、使用 RKE 安装 kubernetes\u003c/h2\u003e\n\u003cp\u003e下面使用 RKE(Kubernetes Engine) 安装高可用的 Kubernetes。\u003c/p\u003e\n\u003ch3 id=\"hash-1-NODE-SERVER-之间建立-ssh-信任\"\u003e1. NODE-SERVER 之间建立 ssh 信任\u003c/h3\u003e\n\u003cp\u003e我们目前有三台服务器用作 local 集群，首先要确保我们主机能够通过 ssh 访问到另外两台主机并执行相关操作。比如执行 docker 命令，还记得前面我们加入 docker 用户组的用户吧。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# 根据需求配置相关信息生成 rsa 公钥密钥\u003c/span\u003e\nssh-keygen\n\n\u003cspan class=\"token comment\"\u003e# 复制当前主机上的公钥到另外两台上面，实现免密码登录\u003c/span\u003e\nssh-copy-id -i ~/.ssh/id_rsa.pub user@x.x.x.x\n\n\u003cspan class=\"token comment\"\u003e# 要注意这里也要跟自己注册注册一下 ：ssh-copy-id -i ~/.ssh/id_rsa.pub user@本机ip\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-2-编写-rancher-cluster-yml-文件\"\u003e2. 编写 rancher-cluster.yml 文件\u003c/h3\u003e\n\u003cp\u003e这里需要注意，这个文件没有明确配置rsa文件名，默认会使用 \u003ccode\u003e$HOME/.ssh/id_rsa\u003c/code\u003e 建立连接。内容如下\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-yml\"\u003e\u003ccode class=\"language-yml\"\u003e\u003cspan class=\"token key atrule\"\u003enodes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003eaddress\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e 168.168.168.6\n    \u003cspan class=\"token key atrule\"\u003einternal_address\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e 10.0.0.6\n    \u003cspan class=\"token key atrule\"\u003euser\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ubuntu\n    \u003cspan class=\"token key atrule\"\u003erole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003econtrolplane\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eworker\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eetcd\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003eaddress\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e 168.168.168.7\n    \u003cspan class=\"token key atrule\"\u003einternal_address\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e 10.0.0.7\n    \u003cspan class=\"token key atrule\"\u003euser\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ubuntu\n    \u003cspan class=\"token key atrule\"\u003erole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003econtrolplane\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eworker\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eetcd\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003e \u003cspan class=\"token key atrule\"\u003eaddress\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e 168.168.168.8\n    \u003cspan class=\"token key atrule\"\u003einternal_address\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e 10.0.0.8\n    \u003cspan class=\"token key atrule\"\u003euser\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ubuntu\n    \u003cspan class=\"token key atrule\"\u003erole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003econtrolplane\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eworker\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eetcd\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n\u003cspan class=\"token key atrule\"\u003eservices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"token key atrule\"\u003eetcd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token key atrule\"\u003esnapshot\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean important\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"token key atrule\"\u003ecreation\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e 6h\n    \u003cspan class=\"token key atrule\"\u003eretention\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e 24h\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-3-运行-RKE-构建-kubernetes-集群\"\u003e3. 运行 RKE 构建 kubernetes 集群\u003c/h3\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003erke up --config ./rancher-cluster.yml\n\u003cspan class=\"token comment\"\u003e# 验证：返回类似下面的消息则说明执行成功，有问题欢迎留言交流。\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Finished building Kubernetes cluster successfully.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e执行成功会在当前目录生成一个文件 \u003ccode\u003ekube_config_rancher-cluster.yml\u003c/code\u003e，将该文件复制到 \u003ccode\u003e.kube/kube_config_rancher-cluster.yml\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e或者\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token builtin class-name\"\u003eexport\u003c/span\u003e \u003cspan class=\"token assign-left variable\"\u003eKUBECONFIG\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e$(\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003epwd\u003c/span\u003e\u003cspan class=\"token variable\"\u003e)\u003c/span\u003e\u003c/span\u003e/kube_config_rancher-cluster.yml\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-4-测试集群\"\u003e4. 测试集群\u003c/h3\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ekubectl get nodes\n\u003cspan class=\"token comment\"\u003e# 返回下面信息说明集群创建成功\u003c/span\u003e\nNAME           STATUS   ROLES                      AGE   VERSION\n\u003cspan class=\"token number\"\u003e168.168\u003c/span\u003e.168.6   Ready    controlplane,etcd,worker   13m   v1.13.5\n\u003cspan class=\"token number\"\u003e168.168\u003c/span\u003e.168.7   Ready    controlplane,etcd,worker   13m   v1.13.5\n\u003cspan class=\"token number\"\u003e168.168\u003c/span\u003e.168.8   Ready    controlplane,etcd,worker   13m   v1.13.5\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-5-保存好相关配置文件\"\u003e5. 保存好相关配置文件\u003c/h3\u003e\n\u003cp\u003e当排除故障、升级群集时需要用到以下文件，请将其副本保存在一个安全的位置。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003erancher-cluster.yml\u003c/code\u003e：RKE集群配置文件。\r\n\u003ccode\u003ekube_config_rancher-cluster.yml\u003c/code\u003e：群集的Kubeconfig文件，此文件包含完全访问群集的凭据。\r\n\u003ccode\u003erancher-cluster.rkestate\u003c/code\u003e：Kubernetes群集状态文件，此文件包含完全访问群集的凭据。\u003c/p\u003e\n\u003ch3 id=\"hash-6-初始化-Helm\"\u003e6. 初始化 Helm\u003c/h3\u003e\n\u003cp\u003e一开始，我们安装了 Helm ，Helm 是 Kubernetes 首选的包管理工具。为了能够使用 Helm，需要在群集上安装服务器端组件 tiller。\u003c/p\u003e\n\u003cp\u003eKubernetes APIServer 开启了 RBAC 访问控制，所以需要创建 tiller 使用的service account: tiller 并分配合适的角色给它。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token comment\"\u003e# 在 kube-system 命名空间下创建一个 serviceaccount ,并将角色绑定给 tiller\u003c/span\u003e\nkubectl -n kube-system create serviceaccount tiller\n\n\u003cspan class=\"token comment\"\u003e# 然后， heml 就可以在集群上安装 tiller 了\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# 同样，网络原因，我们需要配置一个镜像仓库地址\u003c/span\u003e\nhelm init --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.13.1 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts\n\n\u003cspan class=\"token comment\"\u003e# 输出：$HELM_HOME has been configured at /home/ubuntu/.helm.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-7-测试-tiller-安装是否成功\"\u003e7. 测试 tiller 安装是否成功\u003c/h3\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ekubectl -n kube-system  rollout status deploy/tiller-deploy\n\u003cspan class=\"token comment\"\u003e# 输出 deployment \"tiller-deploy\" successfully rolled out\u003c/span\u003e\n\nhelm version\n\u003cspan class=\"token comment\"\u003e# Client: \u0026#x26;version.Version{SemVer:\"v2.13.1\", GitCommit:\"618447cbf203d147601b4b9bd7f8c37a5d39fbb4\", GitTreeState:\"clean\"}\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Server: \u0026#x26;version.Version{SemVer:\"v2.13.1\", GitCommit:\"618447cbf203d147601b4b9bd7f8c37a5d39fbb4\", GitTreeState:\"clean\"}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"hash-五、安装-Rancher\"\u003e五、安装 Rancher\u003c/h2\u003e\n\u003cp\u003e这里注意选择 stable 版本，首先添加 heml 源仓库。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ehelm repo \u003cspan class=\"token function\"\u003eadd\u003c/span\u003e rancher-stable https://releases.rancher.com/server-charts/stable\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-1-部署-Rancher-并配置-SSL-数字证书\"\u003e1. 部署 Rancher 并配置 SSL 数字证书\u003c/h3\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ehelm \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e rancher-stable/rancher \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  --name rancher \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  --namespace cattle-system \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  --set \u003cspan class=\"token assign-left variable\"\u003ehostname\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003ecloud.jfjbapp.cn \u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003e\n  --set ingress.tls.source\u003cspan class=\"token operator\"\u003e=\u003c/span\u003esecret\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-2-将通过-CA-机构签发的数字证书准备好，\"\u003e2. 将通过 CA 机构签发的数字证书准备好，\u003c/h3\u003e\n\u003ch3 id=\"hash-3-检查-rancher-是否成功可用\"\u003e3. 检查 rancher 是否成功可用\u003c/h3\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ekubectl -n cattle-system rollout status deploy/rancher\nWaiting \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e deployment \u003cspan class=\"token string\"\u003e\"rancher\"\u003c/span\u003e rollout to finish: \u003cspan class=\"token number\"\u003e0\u003c/span\u003e of \u003cspan class=\"token number\"\u003e3\u003c/span\u003e updated replicas are available\u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e.\ndeployment \u003cspan class=\"token string\"\u003e\"rancher\"\u003c/span\u003e successfully rolled out\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"hash-4-访问-Rancher-UI\"\u003e4. 访问 Rancher UI\u003c/h3\u003e\n\u003cp\u003e浏览器打开 \u003ccode\u003ehttps://your.doamin\u003c/code\u003e，为 \u003ccode\u003eadmin\u003c/code\u003e账户设置初始密码，并登入系统。提示设置\u003ccode\u003eserver-url\u003c/code\u003e，确保你的地址无误，确认即可。随后稍等皮片刻，待系统完成初始化。\u003c/p\u003e\n\u003cp\u003e如果出现local集群一直停留在等待状态，并提示 \u003ccode\u003eWaiting for server-url setting to be set\u003c/code\u003e，可以尝试点击 全局-\u003elocal-\u003e升级-\u003e添加一个成员角色（admin/ClusterOwner）-\u003e保存即可。\u003c/p\u003e\n\u003ch2 id=\"hash-六、结语\"\u003e六、结语\u003c/h2\u003e\n\u003cp\u003e至此，已完成 Rancher 2.2.2 的 HA 安装，后续再做一些安全加固，检查各项配置确保无安全风险，即可开始提供服务。随后会抽空再写一篇文章简单介绍微服务架构应用的部署。\u003c/p\u003e\n","words":7104,"toc":[{"depth":2,"value":"一、推荐架构","id":"hash-一、推荐架构"},{"depth":2,"value":"二、准备工作","id":"hash-二、准备工作"},{"depth":2,"value":"三、创建节点和负载均衡","id":"hash-三、创建节点和负载均衡"},{"depth":2,"value":"四、使用 RKE 安装 kubernetes","id":"hash-四、使用-RKE-安装-kubernetes"},{"depth":2,"value":"五、安装 Rancher","id":"hash-五、安装-Rancher"},{"depth":2,"value":"六、结语","id":"hash-六、结语"}],"title":"Rancher 2.2.2 - HA 部署高可用k8s集群","author":"高国良","type":"posts","series":false,"date":"2019-05-09T07:33:00.791Z","tags":["rancher","kubernetes","docker"],"description":"当安装在 Kubernetes 集群中时，Rancher 将与集群的 etcd 集成，并利用 Kubernetes 调度实现高可用。","draft":false,"cover":false},"prev":{"title":"VLC-FM PLAYLIST","author":"高国良","type":"posts","series":false,"date":1556741760791,"tags":["fm"],"description":"VLC FM PLAYLIST.xspf","draft":false,"cover":false,"path":"/blogs/2019/vlc-fm-playlist","slug":"2019/vlc-fm-playlist"},"next":{"title":"Fedora 30 安装 Gradle","author":"高国良","type":"posts","series":false,"date":1557673620791,"tags":["Gradle","java","linux"],"description":"Gradle 能够在所有主流操作系统上运行，只要具备 Java JDK/JRE 环境即可，Java 版本必须为 8或更高。","draft":false,"cover":false,"path":"/blogs/2019/install-gradle-on-fedora30","slug":"2019/install-gradle-on-fedora30"}},"__N_SSG":true},"page":"/blogs/[...id]","query":{"id":["2019","rancher-2.2.2-ha-cluster"]},"buildId":"FMhAt0KIvn5yR6X5XTpe4","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>